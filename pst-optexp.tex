%%
%% This is file `pst-optexp.tex',
%%
%% IMPORTANT NOTICE:
%%
%% Package `pst-optexp.tex'
%%
%% Christoph Bersch <usenet _at_ bersch.net>
%%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory CTAN:/macros/latex/base/lppl.txt.
%%
%% DESCRIPTION:
%%   `pst-optexp' is a PSTricks package to draw optical experimental setups
%%
%% HISTORY -> see file Changes
%%
\csname PSToptexpLoaded\endcsname
\let\PSToptexpLoaded\endinput
%
%
\def\fileversion{3.0alpha}
\def\filedate{2011/06/27}
\message{`pst-optexp' v\fileversion, \filedate\space (CB)}
%
\edef\PstAtCode{\the\catcode`\@} \catcode`\@=11\relax
\pst@addfams{optexp}
\pstheader{pst-optexp.pro}
\def\pst@optexpdict{tx@OptexpDict begin }
\def\pst@oe@dict#1{\pst@optexpdict #1 end}
\SpecialCoor
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% IFs for the boolean keys.
%
\newif\ifpoe@compat\poe@compatfalse
\newif\ifpoe@bglayer
\newif\ifpoe@toplayer
\newif\ifpoe@optexpenv
\newif\ifpoe@variable
\newif\ifpoe@voltage
\newif\ifpoe@caxisinv
\newif\ifpoe@reverse
\newif\ifpoe@lamp
\newif\ifpoe@component@optional
\newif\ifpoe@debug@showoptdots
\newif\ifpoe@debug@showifcnodes
\newif\ifpoe@endbox
\newif\ifpoe@thicklens
\newif\ifpoe@usefiberstyle
\newif\ifpoe@fiber@
\newif\ifpoe@fiberin@
\newif\ifpoe@fiberin@top
\newif\ifpoe@fiberin@bottom
\newif\ifpoe@fiberout@
\newif\ifpoe@fiberout@top
\newif\ifpoe@fiberout@bottom
\newif\ifpoe@beam
\newif\ifpoe@startInside
\newif\ifpoe@stopInside
\newif\ifpoe@beaminsidefirst
\newif\ifpoe@beaminsidelast
\newif\ifpoe@startvecabs
\newif\ifpoe@beamInside
\newif\ifpoe@connectplanes
\newif\ifpoe@custombeam\poe@custombeamfalse
\newif\ifpoe@insideobj\poe@insideobjfalse
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Counters
%
% count the components in a pspicture environment
\newcount\poe@cnt
% count the temporal planes which are created for connections to nodes
\newcount\poe@nodecnt
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Fixed strings for choicekeys.
%
\def\poe@str@pol@polperp{perp}
\def\poe@str@pol@polparallel{parallel}
\def\poe@str@pol@polmisc{misc}
\def\poe@str@pol@polrcirc{rcirc}
\def\poe@str@pol@pollcirc{lcirc}
\def\poe@str@mirrortype@piezo{piezo}
\def\poe@str@mirrortype@plain{plain}
\def\poe@str@mirrortype@extended{extended}
\def\poe@str@optgridtype@blazed{blazed}
\def\poe@str@optgridtype@binary{binary}
\def\poe@str@labelref@relative{relative}
\def\poe@str@labelref@relgrav{relgrav}
\def\poe@str@labelref@global{global}
\def\poe@str@filtertype@bandpass{bandpass}
\def\poe@str@filtertype@bandstop{bandstop}
\def\poe@str@filtertype@lowpass{lowpass}
\def\poe@str@filtertype@highpass{highpass}
\def\poe@str@couplertype@none{none}
\def\poe@str@couplertype@elliptic{elliptic}
\def\poe@str@couplertype@rectangular{rectangular}
\def\poe@str@couplertype@crossswitch{crossswitch}
\def\poe@str@top{top}
\def\poe@str@bottom{bottom}
\def\poe@str@center{center}
\def\poe@str@closed{closed}
\def\poe@str@opened{opened}
\def\poe@str@dettype@round{round}
\def\poe@str@dettype@diode{diode}
\def\poe@str@bsstyle@cube{cube}
\def\poe@str@bsstyle@plate{plate}
\def\poe@str@autonode{auto}
%
\def\pst@OptexpVerb#1{\pst@Verb{\pst@optexpdict #1 end }}%
%
% Some strings which control the naming scheme of internal nodes and components.
%
% Default name stem for all internal nodes
\def\poe@str@basicname@default{@}
% The nodes and component names are prefix with this string
\def\poe@str@basicname@prefix{OE@}
% The postfix for external nodes
\def\poe@str@extnode@postfix{Ext}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% psstyles 
%
% Definition of all psstyles and the related keys to change them on the fly
% inside the optional parameters of the referred macro.
%
% Basic style for the device look.
\newpsstyle{OptComp}{}%
\define@key[psset]{optexp}{newOptComp}{\newpsstyle{OptComp}{#1}}
\define@key[psset]{optexp}{addtoOptComp}{\addtopsstyle{OptComp}{#1}}
%
% Style for devices marked as 'optional', inherits from OptComp by default.
\newpsstyle{OptionalStyle}{style=OptComp, linestyle=dashed,dash=1.5pt 1pt}%
%
% Style for beams drawn with \drawbeam
\newpsstyle{Beam}{linecolor=green!90!black,linewidth=\pslinewidth, linejoin=1}%
\define@key[psset]{optexp}{newBeam}{\newpsstyle{Beam}{#1}}
\define@key[psset]{optexp}{addtoBeam}{\addtopsstyle{Beam}{#1}}
%
% Basic look of all fiber connections.
\newpsstyle{Fiber}{}%
\define@key[psset]{optexp}{newFiber}{\newpsstyle{Fiber}{#1}}
\define@key[psset]{optexp}{addtoFiber}{\addtopsstyle{Fiber}{#1}}
%
% Input fiber connections, inherits from Fiber
\newpsstyle{FiberIn}{style=Fiber}%
\define@key[psset]{optexp}{newFiberIn}{\newpsstyle{FiberIn}{#1}}
\define@key[psset]{optexp}{addtoFiberIn}{\addtopsstyle{FiberIn}{#1}}
%
% Output fiber connections, inherits from Fiber
\newpsstyle{FiberOut}{style=Fiber}%
\define@key[psset]{optexp}{newFiberOut}{\newpsstyle{FiberOut}{#1}}
\define@key[psset]{optexp}{addtoFiberOut}{\addtopsstyle{FiberOut}{#1}}
%
% Used for upper (1) and lower (2) input fibers, if present. Inherits from FiberIn.
\newpsstyle{FiberIn1}{style=FiberIn}%
\define@key[psset]{optexp}{newFiberIn1}{\newpsstyle{FiberIn1}{#1}}
\define@key[psset]{optexp}{addtoFiberIn1}{\addtopsstyle{FiberIn1}{#1}}
\newpsstyle{FiberIn2}{style=FiberIn}%
\define@key[psset]{optexp}{newFiberIn2}{\newpsstyle{FiberIn2}{#1}}
\define@key[psset]{optexp}{addtoFiberIn2}{\addtopsstyle{FiberIn2}{#1}}
%
% Used for upper (1) and lower (2) output fibers, if present. Inherits from FiberOut.
\newpsstyle{FiberOut1}{style=FiberOut}%
\define@key[psset]{optexp}{newFiberOut1}{\newpsstyle{FiberOut1}{#1}}
\define@key[psset]{optexp}{addtoFiberOut1}{\addtopsstyle{FiberOut1}{#1}}
\newpsstyle{FiberOut2}{style=FiberOut}%
\define@key[psset]{optexp}{newFiberOut2}{\newpsstyle{FiberOut2}{#1}}
\define@key[psset]{optexp}{addtoFiberOut2}{\addtopsstyle{FiberOut2}{#1}}
%
% Special styles to change only a part of some devices.
\newpsstyle{ExtendedMirror}{linestyle=none,%
                hatchwidth=0.5\poe@key@mirrorlinewidth,
                hatchsep=1.4\poe@key@mirrorlinewidth,%
                fillstyle=hlines}%
\newpsstyle{VariableMirror}{linewidth=0.8\pslinewidth, arrowinset=0, arrowscale=0.8, arrows=<->}
\newpsstyle{PiezoMirror}{fillstyle=solid,fillcolor=black!30}%
\newpsstyle{IsolatorArrow}{linewidth=2\pslinewidth, arrowinset=0}
\newpsstyle{CrystalCaxis}{linestyle=dashed, dash=2pt 2pt, linewidth=0.7\pslinewidth, arrowinset=0, arrows=->}
\newpsstyle{FdlArrow}{arrowinset=0, arrows=->}
\newpsstyle{VariableCoupler}{arrowinset=0, arrows=->}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Parameterdefinitions
%
% General
\define@boolkey[psset]{optexp}[poe@component@]{optional}[true]{}
\define@boolkey[psset]{optexp}[poe@]{usefiberstyle}[true]{}
\define@boolkey[psset]{optexp}[poe@debug@]{showoptdots}[true]{}
\define@boolkey[psset]{optexp}[poe@debug@]{showifcnodes}[true]{}
\define@choicekey*[psset]{optexp}{namingscheme}[\val\nr]{old,new}[new]{%
  \ifcase\nr\relax
    % old naming scheme
    \edef\poe@str@basicname@default{tempNode}
    \edef\poe@str@basicname@prefix{}
    \edef\poe@str@extnode@postfix{ExtNode}
  \or
    \edef\poe@str@basicname@default{@}
    \edef\poe@str@basicname@prefix{OE@}
    \edef\poe@str@extnode@postfix{Ext}
  \fi
}%
%
% Positioning
\define@key[psset]{optexp}{position}{\edef\poe@key@position{#1}}
\define@key[psset]{optexp}{abspos}{\edef\poe@key@abspos{#1}}
\define@key[psset]{optexp}{compshift}{\pst@checknum{#1}\poe@key@compshift}
\define@key[psset]{optexp}{angle}{\pst@checknum{#1}\poe@key@angle}
%
% Layering
\define@boolkey[psset]{optexp}[poe@]{bglayer}[true]{}
\define@boolkey[psset]{optexp}[poe@]{toplayer}[true]{}
\define@boolkey[psset]{optexp}[poe@]{optexpenv}[true]{}
%
% Label
\define@key[psset]{optexp}{labelangle}{\pst@checknum{#1}\poe@key@labelangle}
\define@key[psset]{optexp}{labeloffset}{\pst@checknum{#1}\poe@key@labeloffset}
\define@key[psset]{optexp}{labelstyle}{\def\poe@key@labelstyle{#1}}
\define@key[psset]{optexp}{labelalign}{\def\poe@key@labelalign{#1}}
\define@key[psset]{optexp}{labelref}{\edef\poe@key@labelref{#1}}
\define@key[psset]{optexp}{label}{%
  \pst@expandafter\psset@@label{#1} {} {} {} {} {}\@nil
}%
% parameters: offset angle align ref, intermediate ones can be skipped with a dot
\def\psset@@label#1 #2 #3 #4 #5\@nil{%
  \edef\@empty@dot{.}%
  \edef\pst@temp{#4}%
  \ifx\pst@temp\@empty\else
     \ifx\pst@temp\@empty@dot\else
        \psset{labelref=#4}%
     \fi
  \fi
  \edef\pst@temp{#3}
  \ifx\pst@temp\@empty\else
     \ifx\pst@temp\@empty@dot\else
        \psset{labelalign=#3}%
     \fi
  \fi
  \edef\pst@temp{#2}%
  \ifx\pst@temp\@empty\else
     \ifx\pst@temp\@empty@dot\else
        \psset{labelangle=#2}%
     \fi
  \fi
  \edef\pst@temp{#1}%
  \ifx\pst@temp\@empty\else
     \ifx\pst@temp\@empty@dot\else
        \psset{labeloffset=#1}%
     \fi
  \fi
}%
% for internal use only! Set the reference angle for the labelangle parameter.
\define@key[psset]{optexp}{ref@angle}{\pst@checknum{#1}\poe@key@labelrefangle}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Parameters for free-ray components
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Dipoles
% 
% Lens
\define@key[psset]{optexp}{lensheight}{\pst@checknum{#1}\poe@key@lensheight}
\define@key[psset]{optexp}{lenswidth}{%
  \pst@checknum{#1}\poe@key@lenswidth
  \ifdim\poe@key@lenswidth pt > 0pt
    \psset{thicklens=true}
  \fi
}
\define@key[psset]{optexp}{lensradiusleft}{\pst@checknum{#1}\poe@key@lensradiusleft}
\define@key[psset]{optexp}{lensradiusright}{\pst@checknum{#1}\poe@key@lensradiusright}
\define@boolkey[psset]{optexp}[poe@]{thicklens}[true]{}
\define@key[psset]{optexp}{lensradius}{%
  \edef\pst@temp{#1}%
  \ifx\pst@temp\@empty\else
    \psset{lensradiusleft=#1, lensradiusright=#1}%
  \fi
}%
\define@key[psset]{optexp}{lens}{%
  \pst@expandafter\psset@@lens{#1} {} {} {} {} {}\@nil
}%
% parameters: radiusleft radiusright height width.
\def\psset@@lens#1 #2 #3 #4 #5\@nil{%
  \edef\pst@temp{#4}%
  \ifx\pst@temp\@empty\else
     \psset{lenswidth=#4}%
  \fi
  \edef\pst@temp{#3}%
  \ifx\pst@temp\@empty\else
     \psset{lensheight=#3}
  \fi
  \edef\pst@temp{#2}%
  \ifx\pst@temp\@empty
     \psset{lensradiusright=#1}%
  \else
     \psset{lensradiusright=#2}%
  \fi
  \psset{lensradiusleft=#1}%
}%
%
% Pinhole
\define@key[psset]{optexp}{innerheight}{\pst@checknum{#1}\poe@key@innerheight}
\define@key[psset]{optexp}{outerheight}{\pst@checknum{#1}\poe@key@outerheight}
\define@key[psset]{optexp}{phlinewidth}{\edef\poe@key@phlinewidth{#1}}
\define@key[psset]{optexp}{phwidth}{\edef\poe@key@phwidth{#1}}
%
% Crystal
\define@key[psset]{optexp}{crystalwidth}{\pst@checknum{#1}\poe@key@crystalwidth}
\define@key[psset]{optexp}{crystalheight}{\pst@checknum{#1}\poe@key@crystalheight}
\define@key[psset]{optexp}{caxislength}{\pst@checknum{#1}\poe@key@caxislength}
\define@boolkey[psset]{optexp}[poe@]{voltage}[true]{}
\define@boolkey[psset]{optexp}[poe@]{caxisinv}[true]{}
\define@boolkey[psset]{optexp}[poe@]{lamp}[true]{}
\define@key[psset]{optexp}{lampscale}{\pst@checknum{#1}\poe@key@lampscale}
%
% Box
\define@key[psset]{optexp}{optboxwidth}{\pst@checknum{#1}\poe@key@optboxwidth}
\define@key[psset]{optexp}{optboxheight}{\pst@checknum{#1}\poe@key@optboxheight}
\define@boolkey[psset]{optexp}[poe@]{endbox}[true]{}
%
% Plate
\define@key[psset]{optexp}{platelinewidth}{\edef\poe@key@platelinewidth{#1}}
\define@key[psset]{optexp}{plateheight}{\pst@checknum{#1}\poe@key@plateheight}
%
% Optical Retardation Plate
\define@key[psset]{optexp}{platewidth}{\pst@checknum{#1}\poe@key@platewidth}
%
% Detector
\define@key[psset]{optexp}{detsize}{\pst@checknum{#1}\poe@key@detsize}
\define@choicekey*+[psset]{optexp}{dettype}[\val\nr]{round,diode}%
   {\edef\poe@key@dettype{\val}}
   {\PackageError{pst-optexp}{Unknown value '\val' for key dettype}}
%
% Polarization
\define@key[psset]{optexp}{polsize}{\pst@checknum{#1}\poe@key@polsize}
\define@key[psset]{optexp}{pollinewidth}{\edef\poe@key@pollinewidth{#1}}
\define@choicekey+[psset]{optexp}{poltype}[\val\nr]{parallel,misc,perp,rcirc,lcirc}%
   {\edef\poe@key@poltype{#1}}
   {\PackageError{pst-optexp}{Unknown value '\val' for key poltype}}
%
% Optical Diode
\define@key[psset]{optexp}{optdiodesize}{\pst@checknum{#1}\poe@key@optdiodesize}
%
% Dove Prism
\define@key[psset]{optexp}{doveprismsize}{\pst@checknum{#1}\poe@key@doveprismsize}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Tripoles
%
% Beamsplitter
\define@key[psset]{optexp}{bssize}{\pst@checknum{#1}\poe@key@bssize}
\define@key[psset]{optexp}{bsstyle}{\edef\poe@key@bsstyle{#1}}
%
% Mirror
\define@key[psset]{optexp}{mirrorwidth}{\pst@checknum{#1}\poe@key@mirrorwidth}
\define@key[psset]{optexp}{mirrorlinewidth}{\edef\poe@key@mirrorlinewidth{#1}}
\define@choicekey*[psset]{optexp}{mirrortype}[\val\nr]{piezo,extended,plain}{\edef\poe@key@mirrortype{#1}}
\define@key[psset]{optexp}{mirrordepth}{\pst@checknum{#1}\poe@key@mirrordepth}
\define@key[psset]{optexp}{mirrorradius}{\pst@checknum{#1}\poe@key@mirrorradius}
\define@boolkey[psset]{optexp}[poe@]{variable}[true]{}
%
% Grid
\define@key[psset]{optexp}{optgridcount}{\pst@checknum{#1}\poe@key@optgridcount}
\define@key[psset]{optexp}{optgridwidth}{\pst@checknum{#1}\poe@key@optgridwidth}
\define@key[psset]{optexp}{optgridheight}{\pst@checknum{#1}\poe@key@optgridheight}
\define@choicekey*[psset]{optexp}{optgridtype}[\val\nr]{binary,blazed}{\edef\poe@key@optgridtype{#1}}%
\define@key[psset]{optexp}{optgriddepth}{\pst@checknum{#1}\poe@key@optgriddepth}
\define@key[psset]{optexp}{optgridlinewidth}{\edef\poe@key@optgridlinewidth{#1}}
\define@boolkey[psset]{optexp}[poe@]{reverse}[true]{}
%
%
\define@key[psset]{optexp}{refractiveindex}{\pst@checknum{#1}\poe@key@n}
\define@key[psset]{optexp}{n}{\pst@checknum{#1}\poe@key@n}
\define@key[psset]{optexp}{nmul}{\edef\poe@key@nmul{#1}}
\define@key[psset]{optexp}{nadd}{\edef\poe@key@nadd{#1}}
%
% Penta Prism
\define@key[psset]{optexp}{pentaprismsize}{\pst@checknum{#1}\poe@key@pentaprismsize}
%
% Right-Angle Prism
\define@key[psset]{optexp}{raprismsize}{\pst@checknum{#1}\poe@key@raprismsize}
%
% Prism
\define@key[psset]{optexp}{prismsize}{\pst@checknum{#1}\poe@key@prismsize}
\define@key[psset]{optexp}{prismangle}{\pst@checknum{#1}\poe@key@prismangle}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Parameters for fiber-optical components
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dipoles
%
% Fiber
\define@key[psset]{optexp}{fiberloops}{\pst@checknum{#1}\poe@key@fiberloops}
\define@key[psset]{optexp}{fiberloopradius}{\pst@checknum{#1}\poe@key@fiberloopradius}
\define@key[psset]{optexp}{fiberloopsep}{\pst@checknum{#1}\poe@key@fiberloopsep}
%
% Filter
\define@key[psset]{optexp}{filtersize}{\pst@checknum{#1}\poe@key@filtersize}
\define@choicekey+[psset]{optexp}{filtertype}[\val\nr]{bandstop,bandpass,lowpass,highpass}%
   {\edef\poe@key@filtertype{#1}}%
   {\PackageError{pst-optexp}{Unknown value '\val' for key filtertype}}
%
% Polarization controller
\define@key[psset]{optexp}{polcontrolsize}{\pst@checknum{#1}\poe@key@polcontrolsize}
%
% Optical amplifier
\define@key[psset]{optexp}{optampsize}{\pst@checknum{#1}\poe@key@optampsize}
%
% Mach-Zehnder modulator
\define@key[psset]{optexp}{optmzmsize}{\pst@checknum{#1}\poe@key@optmzmsize}
%
% Isolator
\define@key[psset]{optexp}{isolatorsize}{\pst@checknum{#1}\poe@key@isolatorsize}
%
% Fiber polarizer
\define@key[psset]{optexp}{fiberpolsize}{\pst@checknum{#1}\poe@key@fiberpolsize}
%
% Optical switch
\define@key[psset]{optexp}{switchsize}{\pst@checknum{#1}\poe@key@switchsize}
\define@choicekey+[psset]{optexp}{switchstyle}[\val\nr]{opened,closed}%
   {\edef\poe@key@switchstyle{#1}}%
   {\PackageError{pst-optexp}{Unknown value '\val' for key switchstyle}}
%
% Fiber delay line
\define@key[psset]{optexp}{fdlsize}{\pst@checknum{#1}\poe@key@fdlsize}
%
% Fiber collimator 
\define@key[psset]{optexp}{fibercolsize}{\pst@checknum{#1}\poe@key@fibercolsize}
%
% Coupler
\define@key[psset]{optexp}{couplersize}{\pst@checknum{#1}\poe@key@couplersize}
\define@key[psset]{optexp}{coupleroutshift}{\pst@checknum{#1}\poe@key@coupleroutshift}
\define@key[psset]{optexp}{couplersep}{\pst@checknum{#1}\poe@key@couplersep}
\define@choicekey+[psset]{optexp}{couplertype}[\val\nr]{none,elliptic,crossswitch,rectangular}%
   {\edef\poe@key@couplertype{#1}}%
   {\PackageError{pst-optexp}{Unknown value '\val' for key couplertype}}
\define@key[psset]{optexp}{align}{\edef\poe@key@align{#1}}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% External node
%
\define@key[psset]{optexp}{extnoden@me}{\edef\poe@key@extnoden@me{\poe@str@basicname@prefix#1\poe@str@extnode@postfix}}
%
% (this part was copied and adapted from \psset@@ref from pstricks.tex)
\define@key[psset]{optexp}{extnode}{%
   \edef\poe@key@extnode{#1}%
   \ifx\@empty\poe@key@extnode\else
      \pst@expandafter\psset@@extnode{#1}\@empty,,\@nil
   \fi
}%
\def\poe@key@xref{0}%
\def\poe@key@yref{0}%
\def\psset@@extnode#1#2,#3,#4\@nil{%
  \def\poe@key@xref{0}%
  \def\poe@key@yref{0}%
  \ifx\@empty#3\@empty
    \@nameuse{getref@optexp@#1}%
    \@nameuse{getref@optexp@#2}%
  \else
    \pst@checknum{#1#2}\poe@key@xref%
    \pst@checknum{#3}\poe@key@yref%
  \fi}%
\def\getref@optexp@c{}%
\def\getref@optexp@t{\def\poe@key@yref{1}}%
\def\getref@optexp@b{\def\poe@key@yref{-1}}%
\def\getref@optexp@l{\def\poe@key@xref{-1}}%
\def\getref@optexp@r{\def\poe@key@xref{1}}%
%
%
\define@key[psset]{optexp}{rotateref}{%
   \def\pst@temp{#1}%
   \ifx\@empty\pst@temp\else
      \pst@expandafter\psset@@rotateref{#1}\@empty,,\@nil
   \fi
}%
\def\poe@key@rotate@xref{0}%
\def\poe@key@rotate@yref{0}%
\def\psset@@rotateref#1#2,#3,#4\@nil{%
  \def\poe@key@rotate@xref{0}%
  \def\poe@key@rotate@yref{0}%
  \ifx\@empty#3\@empty
    \@nameuse{getref@optexp@rotate@#1}%
    \@nameuse{getref@optexp@rotate@#2}%
  \else
    \pst@checknum{#1#2}\poe@key@rotate@xref%
    \pst@checknum{#3}\poe@key@rotate@yref%
  \fi}%
\def\getref@optexp@rotate@c{}%
\def\getref@optexp@rotate@t{\def\poe@key@rotate@yref{1}}%
\def\getref@optexp@rotate@b{\def\poe@key@rotate@yref{-1}}%
\def\getref@optexp@rotate@l{\def\poe@key@rotate@xref{-1}}%
\def\getref@optexp@rotate@r{\def\poe@key@rotate@xref{1}}%
%
\define@key[psset]{optexp}{b@sicname}{\edef\poe@key@b@sicname{\poe@str@basicname@prefix#1}}%
%
% List with all component names define until now. Is kept for a single pspicture environment
\gdef\pst@oe@complist{}%
\g@addto@macro{\endpspicture}{%
  \gdef\pst@oe@complist{}\global\poe@cnt=0\relax
}%
%
% Set the component name. If the parameter is empty, a generated name is used.
\define@key[psset]{optexp}{compname}{%
  \ifpoe@insideobj\else
    \PackageError{pst-optexp}{compname allowed only inside an object}
  \fi
  \edef\pst@tmp{#1}
  \ifx\pst@tmp\@empty
    \edef\poe@key@compname{\poe@str@basicname@default\the\poe@cnt}
    \psset{b@sicname=\poe@str@basicname@default\the\poe@cnt}%
    \ifpoe@compat
      \psset{extnoden@me={}}%
     \else
       \psset{extnoden@me=\poe@str@basicname@default\the\poe@cnt}%
     \fi
  \else
    \edef\poe@key@compname{#1}%
    \ifpoe@compat
      \def\poe@str@basicname@prefix{}
      \psset{b@sicname=#1Intern}%
    \else
      \psset{b@sicname=#1}%   
    \fi
    \psset{extnoden@me=#1}%
  \fi
  % check if compname was already defined
  \@expandtwoargs\in@{,\poe@key@compname,}{,\pst@oe@complist,}%
  \ifin@
    \PackageWarning{pst-optexp}%
         {^^Jcompname '\poe@key@compname' already used. Previously defined nodes will be overwritten!^^J}%
  \else
    % Use definition of \XKV@addtolist@x with an \xdef instead of \edef in order
    % to keep the bookkeeping global
    \xdef\pst@oe@complist{\poe@key@compname\ifx\pst@oe@complist\@empty\else,\fi\pst@oe@complist}%
  \fi
}%
%
% Connect a component directly with its reference nodes using \drawbeam
\define@boolkey[psset]{optexp}[poe@]{beam}[true]{}
%
% Select which input fibers are drawn directly
\define@choicekey*[psset]{optexp}{fiberin}[\val\nr]{none,top,bottom,both}[both]{%
  \ifcase\nr\relax
    \psset{fiberin@=false, fiberin@top=false, fiberin@bottom=false}
  \or
    \psset{fiberin@=true, fiberin@top, fiberin@bottom=false, fiber@}
  \or
    \psset{fiberin@=true, fiberin@top=false, fiberin@bottom=true, fiber@}
  \or
    \psset{fiberin@=true, fiberin@top=true, fiberin@bottom=true, fiber@}
  \fi
}%
%
% Select which input fibers are drawn directly
\define@choicekey*[psset]{optexp}{fiberout}[\val\nr]{none,top,bottom,both}[both]{%
  \ifcase\nr\relax
    \psset{fiberout@=false, fiberout@top=false, fiberout@bottom=false}
  \or
    \psset{fiberout@=true, fiberout@top, fiberout@bottom=false, fiber@}
  \or
    \psset{fiberout@=true, fiberout@top=false, fiberout@bottom=true, fiber@}
  \or
    \psset{fiberout@=true, fiberout@top=true, fiberout@bottom=true, fiber@}
  \fi
}%
%
% These are the internal boolkeys for the fiber choices done with 'fiberin' and 'fiberout'
\define@boolkey[psset]{optexp}[poe@]{fiber@}[true]{}
\define@boolkey[psset]{optexp}[poe@]{fiberin@}[true]{}
\define@boolkey[psset]{optexp}[poe@]{fiberin@top}[true]{}
\define@boolkey[psset]{optexp}[poe@]{fiberin@bottom}[true]{}
\define@boolkey[psset]{optexp}[poe@]{fiberout@}[true]{}
\define@boolkey[psset]{optexp}[poe@]{fiberout@top}[true]{}
\define@boolkey[psset]{optexp}[poe@]{fiberout@bottom}[true]{}
\define@boolkey[psset]{optexp}[poe@]{relangle}[true]{}
\define@choicekey+[psset]{optexp}{startnode}[\val\nr]{auto,1,2,3,4,N}%
   {\edef\poe@key@startnode{\val}}
   {\PackageError{pst-optexp}{Unknown value '\val' for key startnode}}
\define@choicekey+[psset]{optexp}{stopnode}[\val\nr]{auto,1,2,3,4,N}%
   {\edef\poe@key@stopnode{\val}}
   {\PackageError{pst-optexp}{Unknown value '\val' for key stopnode}}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\poe@getnode#1#2\@nil{%
  \ifx(#1\relax
    \poe@getcoor#1#2
    \edef\oe@temp{{\pst@coor}}%
  \else
    \ifnum9<1#1 %
      \edef\oe@temp{/\poe@str@basicname@prefix\poe@str@basicname@default#1#2\space}%
    \else
      \edef\oe@temp{/\poe@str@basicname@prefix#1#2\space}%
    \fi
  \fi%
}%
\def\poe@getcoor(#1){%
  \pst@@getcoor{#1}
}%
\def\drawfiber{\drawfiber@{Fiber}}%
\def\drawfiber@#1{%
  \def\pst@par{style=#1}%
  \@ifnextchar[{\drawfiber@i}{\drawfiber@i[]}%
}%
\def\drawfiber@i[#1]#2#3{%
  \addafter@par{#1}%
  \begingroup
    \let\psk@angleA\relax
    \let\psk@angleB\relax
    \use@par
    \def\oe@tempa{#2}
    \ifx\oe@tempa\@empty
      \edef\poe@comps{/\getLastCompname@i\space}
    \else
      \expandafter\poe@getnode#2\@nil
      \edef\poe@comps{\oe@temp}
    \fi
    %
    \def\oe@tempb{#3}
    \ifx\oe@tempb\@empty
      \edef\poe@comps{/\getLastCompname@i\space \poe@comps}
    \else
      \expandafter\poe@getnode#3\@nil
      \edef\poe@comps{\oe@temp\space \poe@comps}
    \fi
    %       
    \ifpoe@bglayer
      \ifx\poe@key@startnode\poe@str@autonode\else
        \pnode(! /\poe@key@startnode\space \poe@comps exch pop \pst@oe@dict{getsubnode} \tx@UserCoor){@@A}
      \fi
      \ifx\poe@key@stopnode\poe@str@autonode\else
        \pnode(! /\poe@key@stopnode\space \poe@comps pop \pst@oe@dict{getsubnode} \tx@UserCoor){@@B}
      \fi
      \ifx\poe@key@startnode\poe@str@autonode
        \ifx\poe@key@stopnode\poe@str@autonode
          \pnode(! \poe@comps exch \pst@oe@dict{NearestNode} \tx@UserCoor){@@A}
          \pnode(! \poe@comps \pst@oe@dict{NearestNode} \tx@UserCoor){@@B}
        \else
          \pnode(! \poe@comps exch pop /N@@@B \pst@oe@dict{@GetCenter ToVec NearestNode} \tx@UserCoor){@@A}
        \fi
      \else\ifx\poe@key@stopnode\poe@str@autonode
        \pnode(! \poe@comps pop /N@@@A \pst@oe@dict{@GetCenter ToVec NearestNode} \tx@UserCoor){@@B}
      \fi\fi
      \pst@getcoor{@@A}\pst@tempa
      \pst@getcoor{@@B}\pst@tempb
      \ifx\psk@angleA\relax
        \psset{angleA=! \pst@oe@dict{\pst@tempb \pst@tempa \poe@comps exch RelFiberAngle}}%
      \else
        \ifpoe@relangle
          \psset{angleA=! \pst@oe@dict{\pst@tempb \pst@tempa \poe@comps exch RelFiberAngle} \psk@angleA\space add}%
        \fi
      \fi
      \ifx\psk@angleB\relax
        \psset{angleB=! \pst@oe@dict{\pst@tempa \pst@tempb \poe@comps RelFiberAngle}}%
      \else
        \ifpoe@relangle
          \psset{angleB=! \pst@oe@dict{\pst@tempa \pst@tempb \poe@comps RelFiberAngle} \psk@angleB\space add }%
      \fi\fi
      \nccurve{@@A}{@@B}
    \fi
  \endgroup
}%
\def\bglayer#1{\ifpoe@bglayer #1\fi\ignorespaces}
\def\toplayer#1{\ifpoe@toplayer #1\fi\ignorespaces}
%
\expandafter\ifx\csname pstoptexp@compat\endcsname\relax%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% New code for \drawbeam
%
\define@key[psset]{optexp}{startvec}{\edef\poe@key@startvec{#1}}%
\define@key[psset]{optexp}{startpos}{\edef\poe@key@startpos{#1}}%
\define@key[psset]{optexp}{beamdiv}{\edef\poe@key@beamdiv{#1}}%
\define@key[psset]{optexp}{beamwidth}{\edef\poe@key@beamwidth{#1}}%
\define@boolkey[psset]{optexp}[poe@]{startInside}[true]{}%
\define@boolkey[psset]{optexp}[poe@]{stopInside}[true]{}%
\define@boolkey[psset]{optexp}[poe@]{beaminsidefirst}[true]{}%
\define@boolkey[psset]{optexp}[poe@]{beaminsidelast}[true]{}%
\define@boolkey[psset]{optexp}[poe@]{beamInside}[true]{}%
\define@boolkey[psset]{optexp}[poe@]{connectplanes}[true]{}%
\define@boolkey[psset]{optexp}[poe@]{startvecabs}[true]{}%
%
% Inside custombeam, sequential uses of \drawbeam can use the ending
% points of previous calls and the lines are combined to a single one
\def\custombeam{\pst@object{custombeam}}%
\def\custombeam@i#1{%
  \ifpoe@bglayer
  \addafter@par{style=Beam}%
  \begin@SpecialObj%
    \let\pst@linetype\pst@arrowtype
    \pst@addarrowdef%
    \poe@custombeamtrue
    \def\begin@SpecialObj{%
      \begingroup%
      \use@par%
      \def\end@SpecialObj{\endgroup\ignorespaces}}%
    \let\@drawbeam\drawbeam
    \def\drawbeam{%
      \let\@strokebeam\@strokesinglebeam
      \def\drawwidebeam{%
        \errmessage{pst-optexp error: You can't switch from single to wide beam in custom mode}%
      }%
      \@drawbeam
    }%
    \let\@drawwidebeam\drawwidebeam
    \def\drawwidebeam{%
      \let\@strokebeam\@strokewidebeam
      \def\drawbeam{%
        \errmessage{pst-optexp error: You can't switch from wide to single beam in custom mode}%
      }%
      \@drawwidebeam
    }%
    \def\begin@WideBeamObj{%
      \begin@BeamObj
      \def\@strokebeam{\addto@pscode{ rearrangeWideBeamPoints }}%
    }%
    \def\begin@SingleBeamObj{%
      \begin@BeamObj
      \def\@strokebeam{\addto@pscode{ rearrangeSingleBeamPoints }}%
    }%
    \addto@pscode{[ }%
    #1%
    \ifx\pslinestyle\@none
      \addto@pscode{ cleartomark }%
    \else
      \addto@pscode{\pst@optexpdict }%
      \@strokebeam
      \addto@pscode{ end }%
    \fi
  \end@SpecialObj%
  \fi
\ignorespaces}%
%
\def\begin@BeamObj{%
  \addbefore@par{n=0}%
  \begin@SpecialObj%
  \addto@pscode{%
     \pst@optexpdict 
     /beaminsidefirst \ifpoe@beaminsidefirst true \else false \fi def
     /beaminsidelast \ifpoe@beaminsidelast true \else false \fi def
     /beamInside \ifpoe@beamInside true \else false \fi def
     /custombeam \ifpoe@custombeam true \else false \fi def
     /startInside \ifpoe@startInside true \else false \fi def
     /stopInside \ifpoe@stopInside true \else false \fi def
     /connectplanes \ifpoe@connectplanes true \else false \fi def
     /startvecabs \ifpoe@startvecabs true \else false \fi def
  }%
}%
\def\begin@WideBeamObj{%
  \addafter@par{style=Beam}%
  \begin@BeamObj
  \let\pst@linetype\pst@arrowtype
  \pst@addarrowdef%
  \let\@strokebeam\@strokewidebeam
}%
\def\begin@SingleBeamObj{%
  \addbefore@par{style=Beam}%
  \begin@BeamObj
  \let\pst@linetype\pst@arrowtype
  \pst@addarrowdef%
  \let\@strokebeam\@strokesinglebeam
}
%
\def\drawbeam{\pst@object{drawbeam}}%
\def\drawbeam@i{%
  \begin@SingleBeamObj
  \poe@getcomps[\drawbeam@ii%
}%
\def\drawwidebeam{\pst@object{drawwidebeam}}%
\def\drawwidebeam@i{%
  \begin@WideBeamObj
  \poe@getcomps[\drawwidebeam@ii%
}%
\def\end@BeamObj{%
  \addto@pscode{ end}%
  \let\psk@fillstyle\relax
  \ifpoe@optexpenv
    \ifpoe@toplayer
      \def\pst@code{}%
    \fi
  \fi
  \end@SpecialObj%
}%
\def\drawbeam@ii{%
  \ifx\pslinestyle\@none\else
    \addto@pscode{%
     {/nmul \poe@key@nmul\space def
      /nadd \poe@key@nadd\space def
      /nforce \poe@key@n\space def} }%
    \ifx\poe@key@startpos\@empty
      \addto@pscode{ {0 0} }%
    \else
      \addto@pscode{ [\poe@key@startpos\space counttomark 1 eq { 0 exch } if \tx@ScreenCoor] cvx }%
    \fi
    \addto@pscode{%
       [\ifx\poe@key@startvec\@empty 1 0 \else \poe@key@startvec\fi\space 
        counttomark 1 eq { 1 exch } if ] cvx
    }%
    \addto@pscode{ TraceBeam }%
    \@strokebeam
  \fi
  \end@BeamObj
}%
\def\@strokesinglebeam{%
  \addto@pscode{%
    gsave 
      Drawbeam 
      \tx@setlinejoin
      \pst@number\pslinewidth SLW
      \pst@usecolor\pslinecolor
      \tx@setStrokeTransparency
      \@nameuse{psls@\pslinestyle}
    grestore
  }%
}%
\def\drawwidebeam@ii{%
  \def\pst@fill##1{ gsave ##1 grestore }%
  \addto@pscode{%
   {/nmul \poe@key@nmul\space def
    /nadd \poe@key@nadd\space def
    /nforce \poe@key@n\space def
    /beamdiv \ifx\poe@key@beamdiv\@empty 0 \else \poe@key@beamdiv\fi\space def} }%
  % the input vectors
    \addto@pscode{%
      [\ifx\poe@key@startvec\@empty 1 0 \else\poe@key@startvec\fi\space
       counttomark 1 eq { 1 exch } if 
%       ] cvx dup
       \ifx\poe@key@beamdiv\@empty 0 \else \poe@key@beamdiv\fi\space
       matrix rotate 3 copy itransform ToVec
       5 1 roll transform ] cvx exch
    }%
  % the start positions
  \addto@pscode{%
    [\ifx\poe@key@startpos\@empty 0 0 \else\poe@key@startpos\space\fi
     counttomark 1 eq { 0 exch } if
     \ifx\poe@key@beamwidth\@empty 0 \else \poe@key@beamwidth\space 0.5 mul \fi\space
     3 copy add \tx@ScreenCoor\space ToVec 5 1 roll sub \tx@ScreenCoor] cvx
  }%
  % rearrange options
  \addto@pscode{ exch 4 -1 roll 4 2 roll exch }% 
  %
  % stroke and/or fill
  \ifx\psk@fillstyle\relax\else
    \addto@pscode{%
      counttomark 1 add copy 
      gsave
        /fillBeam { \psk@fillstyle } def
        currentdict /lastBeamPointLow known { /TmpLastBeamPointLow /lastBeamPointLow load def} if
        currentdict /lastBeamPointUp known { /TmpLastBeamPointUp /lastBeamPointUp load def} if
        FillWideBeam
      grestore pop
    }%
  \fi%
  % stroke
  \ifx\pslinestyle\@none
    \addto@pscode{ cleartomark }%
  \else
    \ifx\psk@fillstyle\relax\else
      \addto@pscode{ restoreBeamPoints }%
    \fi
    \addto@pscode{ TraceWideBeam }%
    \@strokebeam
  \fi
  \end@BeamObj
}%
\def\@strokewidebeam{%
  \@strokesinglebeam
  \@strokesinglebeam
}%
%
\def\poe@getcomps#1#2{%
  \def\poe@aftercomps{\addto@pscode{#1 \poe@comps }#2}%
  \def\poe@comps{}%
  \poe@@getcomps%
}%
%
\def\poe@@getcomps{%
  \@ifnextchar\bgroup{\poe@@@getcomps}{\poe@aftercomps}%
}%
\def\poe@@@getcomps#1{\def\oe@temp{#1\@empty}\expandafter\poe@@@@getcomps\oe@temp\@nil}%
\def\poe@@@@getcomps#1#2\@nil{%
  \edef\oe@temp{#1}%
  \ifx\oe@temp\@empty
    \poe@getcomp{(\getLastCompname@i)}%
  \else\ifx(#1\relax
    \poe@getplanenode#1#2%
  \else\ifnum9<1#1
    \poe@getcomp{(\poe@str@basicname@prefix\poe@str@basicname@default#1#2)}%
  \else
    \poe@getcomp{(\poe@str@basicname@prefix#1#2)}%
  \fi\fi\fi%
  \poe@@getcomps%
}%
\def\poe@getplanenode(#1){%
   \pst@@getcoor{#1}%
   \advance\poe@nodecnt by 1
   \poe@getcomp{{\pst@coor} {0 1} (\poe@str@basicname@default N@\the\poe@nodecnt) {\tx@UserCoor} NewTempNodeComp (\poe@str@basicname@default N@\the\poe@nodecnt) }%
}%
\def\poe@getcomp#1{%
   \edef\poe@comps{#1 \poe@comps}%
}%
\def\draw@InternalConnections{%
  \ifpoe@beam
    \ifpoe@endbox
      \drawbeam[connectplanes]{(\oenoderefa{})}{\poe@key@compname}
    \else
      \drawbeam[connectplanes]{(\oenoderefa{})}{\poe@key@compname}{(\oenoderefb{})}
    \fi
  \else
    \ifpoe@endbox
      \ifpoe@fiberin@
        \drawfiber@{FiberIn}{(\oenoderefa{})}{\poe@key@compname}
      \fi
    \else
      \ifpoe@fiberin@
        \drawfiber@{FiberIn}{(\oenoderefa{})}{\poe@key@compname}
      \fi
      \ifpoe@fiberout@
        \drawfiber@{FiberOut}{\poe@key@compname}{(\oenoderefb{})}
      \fi
    \fi
  \fi
}%
\define@choicekey[psset]{optexp}{fiber}[\val\nr]{}[]{%
   \psset{fiberin, fiberout}%
}
\define@choicekey[psset]{optexp}{nofiber}[\val\nr]{}[]{%
   \psset{fiberin=none, fiberout=none}%
}
\psset{%
        startInside=false
        ,stopInside=false
        ,beamInside=true
        ,startvec=\@empty
        ,startpos=\@empty
        ,startvecabs=false
        ,beamwidth=0
        ,beamdiv=\@empty
        ,nmul=1
        ,nadd=0
        ,namingscheme=new
}%
\else
  \input{pst-optexp-compat.tex}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END OF NEW CONNECTION CODE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\def\pst@optexp@check@compname#1{%
   % check if 'compname' is defined
   \@expandtwoargs\in@{,#1,}{,\pst@oe@complist,}%
   \ifin@\else
      \PackageError{pst-optexp}{^^Jcompname '#1' undefined!^^J}
   \fi
}%
%
%
%\def\poe@nodeIn{\poe@key@b@sicname 1}%
%\def\poe@nodeOut{\poe@key@b@sicname N}%
%\def\poe@refnodeA{\poe@key@b@sicname A}%
%\def\poe@refnodeB{\poe@key@b@sicname B}%
%\def\poe@nodeLabel{\poe@key@b@sicname Label}%
%\def\poe@nodeLabelShifted{\poe@key@b@sicname LabelShifted}%
%\def\poe@node#1{\poe@key@b@sicname #1}%
%
%
%
\def\getLastCompname@ii#1,#2,#3\@nil{#1}%
\def\getLastCompname@i{\poe@str@basicname@prefix\expandafter\getLastCompname@ii \pst@oe@complist,\relax,\@nil}%
\def\oenode#1#2{%
  \ifx.#1.%
    \getLastCompname@i
  \else
    \poe@str@basicname@prefix
    \ifnum9<1#1 
      \poe@str@basicname@default
    \fi
    #1%
    \fi
  #2%
}%
\def\oenodeext#1{\oenode{#1}{\poe@str@extnode@postfix}}%
\def\oenodein#1{\oenode{#1}{1}}%
\def\oenodeout#1{\oenode{#1}{N}}%
\def\oenoderefa#1{\oenode{#1}{A}}%
\def\oenoderefb#1{\oenode{#1}{B}}%
\def\oenodecenter#1{\oenode{#1}{Center}}%
\def\oenodelabel#1{\oenode{#1}{Label}}%
%
\def\newOptexpComp{\@ifnextchar[{\newOptexpComp@i}{\newOptexpComp@i[]}}%
\def\newOptexpComp@i[#1]#2{%
    \pst@OptexpVerb{#1 [ #2 (\poe@key@b@sicname) {\tx@ScreenCoor} false NewOptexpComp}%
}%
\def\newOptexpCompAmb{\@ifnextchar[{\newOptexpCompAmb@i}{\newOptexpCompAmb@i[]}}%
\def\newOptexpCompAmb@i[#1]#2{%
    \pst@OptexpVerb{#1 [ #2 (\poe@key@b@sicname) {\tx@ScreenCoor} true NewOptexpComp}%
}%
\def\optplane(#1)(#2)#3{%
    \pst@getcoor{#1}\pst@tempOrig%
    \pst@getcoor{#2}\pst@tempDiff%
    \pst@OptexpVerb{{\pst@tempOrig} gsave STV CP T exec grestore ToVec {\pst@tempDiff} (\poe@str@basicname@prefix#3) {} NewNodeComp}%
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% BASIC MACROS
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\def\begin@OptexpObj{%
   \global\advance\poe@cnt by 1
   % init comp name
   \addbefore@par{compname={}}
   \pst@killglue
   \begingroup
      \poe@insideobjtrue
      \pst@OptexpVerb{InitOptexpComp}%
      \use@par
      % Usually the shift refers to the y-direction, shifting in x-direction
      % is done by 'abspos' or 'position'
      \let\poe@key@comp@Yshift\poe@key@compshift%
      \def\poe@key@comp@Xshift{0}%
}%
\def\begin@OptexpMultipole{%
   \begin@OptexpObj
   % for multipoles the default shifting is in x-direction
   \let\poe@key@comp@Xshift\poe@key@compshift%
   \def\poe@key@comp@Yshift{0}%
}%
\def\end@OptexpObj{%
  \endgroup
  \ignorespaces%
}%
\let\end@OptexpDipole\end@OptexpObj
\let\end@OptexpMultipole\end@OptexpObj
%
% Command analog to addbefore@par which is defined in pstricks.tex
% addafter@par inserts new options at the _end_ of the current token register.
% This can be useful to preset options that are not allowed to be changed by the
% user.
%
\def\addafter@par#1{%
  \ifx\pst@par\@empty
    \def\pst@par{#1}%
  \else
    \toks@{#1}%
    \pst@toks\expandafter{\pst@par}%
    \edef\pst@par{\the\pst@toks,\the\toks@}%
  \fi%
}%
\def\getCLWH{CLW \pst@number\psxunit 2 mul div }%
\def\getCLW{CLW \pst@number\psxunit div }%
% Define new node '#3' which is shifted by (#1) relative to an existing
% node '#2'
\def\defShiftedNode(#1)(#2)#3{%
     \pst@getcoor{#1}\pst@tempOrig%
     \pst@getcoor{#2}\pst@tempDiff%
     \pnode(!\pst@tempDiff \pst@tempOrig 
             3 -1 roll add 3 1 roll add exch \tx@UserCoor){#3}%
}%
%
% New high-level macros 
% 1) Allow a compressed notation of all provided elements, as most of the organizing code 
%    is mostly equal.
%
% 2) Provide a rather easy-to-use interface for the user to allow new user-defined elements
%
\def\newOptexpDipole{\@ifnextchar[{\new@optexpdipole}{\new@optexpdipole[]}}
\def\newOptexpDipoleNolabel{\@ifnextchar[{\new@optexpdipolenolabel}{\new@optexpdipolenolabel[]}}
\def\newOptexpTripole{\@ifnextchar[{\new@optexptripole}{\new@optexptripole[]}}
\def\newOptexpFiberDipole{\@ifnextchar[{\new@optexpfiberdipole}{\new@optexpfiberdipole[]}}
\def\newOptexpFiberQuadrupole{\@ifnextchar[{\new@optexpfiberquadrupole}{\new@optexpfiberquadrupole[]}}
%
% Creates new macros ...@i and ...@ii which provide most code for the arrangement
% of the objects. A \poe@nodeLabel is predefined as well as two internal nodes if compname is
% defined.
% ...@iii must be defined manually and should contain all the stroking code
\def\new@optexpdipole[#1]#2#3{%
  \@ifundefined{#2@i}{%
    \@namedef{#2}{\pst@object{#2}}%
    \expandafter\def\csname #2@i\endcsname(##1)(##2)##3{%
      \addbefore@par{#3}%
      \addafter@par{#1}%
      \begin@OptexpObj
        \ifpoe@bglayer
          \pst@regNodes{##1}{##2}
          \pst@adjustTempNodes
        \fi
        \pst@draw@component[#2]{##3}{\@nameuse{#2@ii}}
        \ifpoe@bglayer
          % connect
          \draw@InternalConnections
        \fi
      \end@OptexpObj
    }%
    \dipole@iimacro{#2}%
  }{%
    \@pstrickserr{OptExp dipole object `#2' already defined}\@eha}%
\ignorespaces}%
%
\def\new@optexpfiberdipole[#1]#2#3{%
  \@ifundefined{#2@i}{%
    \@namedef{#2}{\pst@object{#2}}%
    \expandafter\def\csname #2@i\endcsname(##1)(##2)##3{%
      \addbefore@par{fiber, #3}%
      \addafter@par{#1}%
      \begin@OptexpObj
        \ifpoe@bglayer
          \pst@regNodes{##1}{##2}
          \pst@adjustTempNodes
        \fi
        \pst@draw@component[#2]{##3}{\@nameuse{#2@ii}}
        \ifpoe@bglayer
          % connect
          \draw@InternalConnections
        \fi
        \end@OptexpObj
      }%
      \fiberdipole@iimacro{#2}%
   }{%
     \@pstrickserr{OptExp fiber dipole object `#2' already defined}\@eha}%
\ignorespaces}%
%
% Equivalent to new@optexdipole, only that objects without labels are created.
\def\new@optexpdipolenolabel[#1]#2#3{%
  \@ifundefined{#2@i}{%
    \@namedef{#2}{\pst@object{#2}}%
    \expandafter\def\csname #2@i\endcsname(##1)(##2){%
      \addbefore@par{#3}%
      \addafter@par{#1}%
      \begin@OptexpObj
        \ifpoe@bglayer     
          \pst@regNodes{##1}{##2}
          \pst@adjustTempNodes
        \fi
        \pst@draw@component[#2]{}{\@nameuse{#2@ii}}
        % connect
        \ifpoe@bglayer
          \draw@InternalConnections
        \fi
      \end@OptexpObj
    }%
    \dipole@iimacro{#2}%
   }{%
     \@pstrickserr{OptExp dipole object `#2' already defined}\@eha}%
\ignorespaces}%
%
% Equivalent to new@optexpdipole for tripole objects.
\def\new@optexptripole[#1]#2#3{%
   \@ifundefined{#2@i}{%
      \@namedef{#2}{\pst@object{#2}}%
      \expandafter\def\csname #2@i\endcsname(##1)(##2)(##3)##4{%
         \addbefore@par{#3}%
         \addafter@par{ref@angle=180,#1}%
         \begin@OptexpMultipole
%           \message{^^J\poe@refnodeA^^J}%
%            \ifpoe@bglayer
              \pst@calcNodes{##1}{##2}{##3}%
              % adjust tempNode@A and tempNode@B for the connections
              % \pnode(##1){tempNode@A}
              % \pnode(##3){tempNode@B}
              % check if node must be switched, therefore we implement this
              % directly as PS code
%            \fi
            \pst@draw@component[#2]{##4}{\@nameuse{#2@ii}}
            \ifpoe@bglayer
              \pst@getcoor{##1}\pst@tempA%
              \pst@getcoor{##3}\pst@tempB%
              \pst@OptexpVerb{%
                 tx@NodeDict begin
                     {\pst@tempA } false chirality 0 le { /N@\oenoderefb{}\space }{ /N@\oenoderefa{}\space } ifelse
                     10 {InitPnode } NewNode
                     {\pst@tempB } false chirality 0 le { /N@\oenoderefa{}\space }{ /N@\oenoderefb{}\space } ifelse
                     10 {InitPnode } NewNode
                 end
              }%
              \draw@InternalConnections
            \fi
         \end@OptexpMultipole
      }%
      \tripole@iimacro{#2}%
   }{%
     \@pstrickserr{OptExp tripole object `#2' already defined}\@eha}%
\ignorespaces}%
%
% 
\def\new@optexpfiberquadrupole[#1]#2#3{%
  \@ifundefined{#2@i}{%
    \@namedef{#2}{\pst@object{#2}}%
    \expandafter\def\csname #2@i\endcsname(##1)(##2)(##3)(##4)##5{%
      \addbefore@par{fiber, #3}%
      \addafter@par{#1}%
      %
      \begin@OptexpObj
      %
        \ifpoe@bglayer
          \ifx\poe@key@align\poe@str@top
            \pnode(##1){\oenoderefa{}}
            \pnode(##3){\oenoderefb{}}
          \else\ifx\poe@key@align\poe@str@bottom
            \pnode(##2){\oenoderefa{}}
            \pnode(##4){\oenoderefb{}}
          \else
            \pst@getcoor{##1}\pst@tempA%
            \pst@getcoor{##2}\pst@tempB%
            \pnode(!\pst@tempA \pst@tempB \pst@optexpdict mwNode end \tx@UserCoor){\oenoderefa{}}
            \pst@getcoor{##3}\pst@tempA%
            \pst@getcoor{##4}\pst@tempB%
            \pnode(!\pst@tempA \pst@tempB \pst@optexpdict mwNode end \tx@UserCoor){\oenoderefb{}}
         \fi\fi
       \fi
       %
       \pst@draw@component[#2]{##5}{\@nameuse{#2@ii}}
       \ifpoe@bglayer
         % connect the fibers
         \ifpoe@fiberin@top
           \drawfiber@{FiberIn1}[stopnode=1]{(##1)}{\poe@key@compname}
         \fi
         \ifpoe@fiberin@bottom
           \drawfiber@{FiberIn2}[stopnode=2]{(##2)}{\poe@key@compname}
         \fi
         \ifpoe@fiberout@top
           \drawfiber@{FiberOut}[startnode=3]{\poe@key@compname}{(##3)}
         \fi
         \ifpoe@fiberout@bottom
           \drawfiber@{FiberOut2}[startnode=N]{\poe@key@compname}{(##4)}
         \fi
       \fi
     \end@OptexpObj
    }%
    \fiberdipole@iimacro{#2}%
  }{%
    \@pstrickserr{OptExp fiber quadrupole object `#2' already defined}\@eha}%
\ignorespaces}%
\def\dipole@iimacro#1{%
  \dipole@iimacro@{#1}{\dipole@nodes}%
\ignorespaces}%
\def\fiberdipole@iimacro#1{%
  \dipole@iimacro@{#1}{\fiberdipole@nodes}%
\ignorespaces}%
\def\tripole@iimacro#1{%
  \dipole@iimacro@{#1}{\tripole@nodes}%
\ignorespaces}%
\def\dipole@iimacro@#1#2{%
  \@namedef{#1@ii}{%
    \ifpoe@bglayer
      \pnode(0,0){\oenodecenter{}}%
    \fi
    \@ifundefined{#1@iii}{%
      \ifpoe@bglayer
        \@ifundefined{#1@nodes}{#2}{\@nameuse{#1@nodes}}%
      \fi
      \ifpoe@toplayer
        \@nameuse{#1@comp}%
      \fi
    }{%
      \ifpoe@bglayer
        \@nameuse{#1@iii}%
      \fi
    }%
  }%
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fiber tripole macros
% 
\def\wdmsplitter{\pst@object{wdmsplitter}}%
\def\wdmsplitter@i(#1)(#2)(#3)#4{%
  \addbefore@par{fiber}%
  \begin@OptexpObj
    \ifpoe@bglayer
      \pnode(#1){\oenoderefa{}}
      \ifx\poe@key@align\poe@str@top
         \pnode(#2){\oenoderefb{}}
      \else\ifx\poe@key@align\poe@str@bottom
         \pnode(#3){\oenoderefb{}}
      \else
         \pst@getcoor{#2}\pst@tempA%
         \pst@getcoor{#3}\pst@tempB%
         \pnode(!\pst@tempA\pst@number\psyunit div exch \pst@number\psxunit div exch
                 \pst@tempB\pst@number\psyunit div exch \pst@number\psxunit div exch 
                 \pst@optexpdict mwNode end \poe@key@coupleroutshift\space add){\oenoderefb{}}
      \fi\fi
    \fi
    %
    \pst@draw@component[wdmsplitter]{#4}\wdmsplitter@ii
    \ifpoe@bglayer
      % connect the fibers
      \ifpoe@fiberin@
        \drawfiber@{FiberIn}[stopnode=1]{(#1)}{\poe@key@compname}
      \fi
      \ifpoe@fiberout@top
        \drawfiber@{FiberOut1}[startnode=2]{\poe@key@compname}{(#2)}
      \fi
      \ifpoe@fiberout@bottom
        \drawfiber@{FiberOut2}[startnode=N]{\poe@key@compname}{(#3)}
      \fi
    \fi
  \end@OptexpObj
}%
\fiberdipole@iimacro{wdmsplitter}%
%
%
\def\wdmcoupler{\pst@object{wdmcoupler}}%
\def\wdmcoupler@i(#1)(#2)(#3)#4{%
  \addbefore@par{fiber}%
  \begin@OptexpObj
    \ifpoe@bglayer
      \pnode(#3){\oenoderefb{}}
      \ifx\poe@key@align\poe@str@top
         \pnode(#1){\oenoderefa{}}
      \else\ifx\poe@key@align\poe@str@bottom
         \pnode(#2){\oenoderefa{}}
      \else
         \pst@getcoor{#1}\pst@tempA%
         \pst@getcoor{#2}\pst@tempB%
         \pnode(!\pst@tempA\pst@number\psyunit div exch \pst@number\psxunit div exch
                 \pst@tempB\pst@number\psyunit div exch \pst@number\psxunit div exch 
                 \pst@optexpdict mwNode end){\oenoderefa{}}
      \fi\fi
    \fi
    %
    \pst@draw@component[wdmcoupler]{#4}\wdmcoupler@ii
    \ifpoe@bglayer 
      % connect the fibers
      \ifpoe@fiberout@
        \drawfiber@{FiberOut}[startnode=N]{\poe@key@compname}{(#3)}
      \fi
      \ifpoe@fiberin@top
        \drawfiber@{FiberIn1}[stopnode=1]{(#1)}{\poe@key@compname}
      \fi
      \ifpoe@fiberin@bottom
        \drawfiber@{FiberIn2}[stopnode=2]{(#2)}{\poe@key@compname}
      \fi
    \fi
  \end@OptexpObj
}%
\fiberdipole@iimacro{wdmcoupler}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Some of the components need three points to be positioned. 
%   These are:
%
%       1. starting point of the beam (in the PS-Code: (XA,YA))
%       2. reflection point on the surface (XG, YG)
%       3. end point (XB,YB)
%
%  With these three points \pst@calcNodes calculates two new points 'tempNode@A' 
%  and 'tempNode@B', between which the component is placed by the macro 
%  \pst@draw@component in the way, that 'angle of incidence' == 'angle of deflection'
%  regarding the reflection surface (mirror, diagonal of the beamsplitter, 
%  grid etc.)
% 
\def\pst@calcNodes#1#2#3{{%
  \pst@getcoor{#1}\pst@tempa%
  \pst@getcoor{#2}\pst@tempb%
  \pst@getcoor{#3}\pst@tempc%
  \pnode(!%
     \pst@optexpdict
     \pst@tempa \tx@UserCoor
     \pst@tempc \tx@UserCoor
     \pst@tempb \tx@UserCoor
     calcNodes
     /ExchCoorSwitch 
     Y@A X@A neg Y@B X@B neg ExchCoor def
     X@A Y@A end){\oenoderefa{}}%
  \pnode(! \pst@oe@dict{X@B Y@B}){\oenoderefb{}}%
  \pst@OptexpVerb{/@xref \poe@key@xref\space def /@yref \poe@key@yref\space def}%
}\ignorespaces}%
%
%
% If a macro needs only two points, they are equivalent to 
% 'tempNode@A' and 'tempNode@B'. But for easier implementation of other 
% macros the given points are assigned to the temporary nodes.
%
\def\pst@regNodes#1#2{%
    \pnode(#1){\oenoderefa{}}
    \pnode(#2){\oenoderefb{}}
\ignorespaces}%
\def\pst@adjustTempNodes{%
    \pst@OptexpVerb{%
      (N@\oenoderefa{}) @GetCenter (N@\oenoderefb{}) @GetCenter
      currentdict /chirality known not {%
        /chirality 1 def 
      } if
      ExchCoor dup /ExchCoorSwitch ED 
      {/@xref \poe@key@xref\space neg def /@yref \poe@key@yref\space neg def} 
      {/@xref \poe@key@xref\space def /@yref \poe@key@yref\space def} ifelse
    }%
\ignorespaces}%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Some other usefuls macros
%
% Define a new node #3 shifted by (#1) relative to existing node #2.
% Aditionally rotate the new node by #4 degree around existing node as origin.
%
\def\poe@pnode@shiftedrot(#1)#2#3#4{%
    \pst@getcoor{#1}\pst@tempDiff%
    \pnode(!%
       \pst@tempDiff /YDiff ED /XDiff ED %
         /N@#2 load GetCenter /YShifted ED /XShifted ED
         /rot@angle #4 \poe@key@labelrefangle\space add def
         /XDiff@Rot rot@angle cos XDiff mul rot@angle sin YDiff mul add def
         /YDiff@Rot rot@angle cos YDiff mul rot@angle sin XDiff mul sub def
         XShifted XDiff@Rot add YShifted YDiff@Rot add neg \tx@UserCoor
       ){#3}%
    % reset reference label to 0
    \psset{ref@angle=0}
}%
%
% Used to put the label for labelref=relative
%
\def\poe@putlabelrelative#1{%
   \nput[labelsep=0]{\poe@key@labelangle}%
        {\oenodelabel{}}%
        {\rput[\poe@key@labelalign](0,0){\poe@key@labelstyle #1}}%
}%
%
% Place the component in argument #1 and define a new node '\poe@nodeLabelShifted'
% for positioning of the label
\def\poe@putcomp#1#2{%
  \@ifundefined{#1@ref}{}{\@nameuse{#1@ref}}%
  \ifdim\poe@key@angle pt=0pt
    \poe@putcomp@i{#2}
  \else
    \psrotate(! \pst@oe@dict{@@x0 @@x \poe@key@rotate@xref\space mul add
                         @@y0 @@y \poe@key@rotate@yref\space mul add}){\poe@key@angle}{\poe@putcomp@i{#2}}%
  \fi
}%
\def\poe@putcomp@i#1{%
   \rput(\poe@key@comp@Xshift,\poe@key@comp@Yshift){%
      #1%
      \poe@pnode@shiftedrot(0,\poe@key@labeloffset)%
                           {\oenodecenter{}}%
                           {\oenodelabel{}}%
                           {\poe@key@labelangle}%
   }%
}%
%
% Positioning of the label depending on the reference coordinates.
% Needs possibly a previously defined node \poe@nodeLabelShifted which
% marks exactly the position of the label relative to the component.
% This is defined by calling \put@Comp.
% 
% Parameter 'labelref' which sets the reference coordinates can have 
% the values 
%   global   => labelangle rotates the label origin in global coordinate 
%               system, text is not rotated
%   relgrav  => labelangle rotates the label origin relativ to the local
%               coordinate system of the component, text is not rotated
%   relative => as relgrav but text is rotated together with object.
%
\def\poe@putlabel#1{%
   \def\pst@temp{#1}%
   \ifx\pst@temp\@empty\else
   \ifx\poe@key@labelref\poe@str@labelref@global
      %
      % global
      \nput[labelsep=\poe@key@labeloffset]%
           {\poe@key@labelangle}%
           {\oenodecenter{}}%
           {\rput[\poe@key@labelalign](0,0){\poe@key@labelstyle #1}}%
      %
   \else\ifx\poe@key@labelref\poe@str@labelref@relgrav
      %
      % relgrav
      \rput[\poe@key@labelalign](\oenodelabel{}){\poe@key@labelstyle #1}%
      %
   \else\ifx\poe@key@labelref\poe@str@labelref@relative
      %
      % relative
      \begingroup
      %
      % Redefine InitNC only for positioning of the label with 
      % labelref=relative
      %
      \pst@def{InitNC}<       % kindly contributed by Herbert Voss
      /b ED /a ED % second and first node
      /NodeSepTypeB ED /NodeSepTypeA ED
      /NodeSepB ED /NodeSepA ED
      /OffsetB ED /OffsetA ED
      tx@NodeDict a known tx@NodeDict b known and dup {
        /NodeA a load def /NodeB b load def
        NodeA GetCenter NodeB GetCenter % xA yA xB yB
        4 copy exch 4 -1 roll 2 copy gt % yA yB xB xA
%        4 copy pop exch pop le % xA xB
          { pop pop pop pop /yB ED /xB ED /yA ED /xA ED }
          { eq 3 1 roll lt and 
              { /yB ED /xB ED /yA ED /xA ED} 
              { /yA ED /xA ED /yB ED /xB ED} ifelse
          } ifelse
      } if >%
      % 
      \ncline[linestyle=none,fillstyle=none,npos=]{\oenoderefa{}}{\oenoderefb{}}%
      % 
      % 
      \ifx\poe@key@position\@empty
         \ifx\poe@key@abspos\@empty
            \ncput[nrot=:U,npos=]{\poe@putlabelrelative{#1}}%
         \else
            \nlput[nrot=:U](\oenoderefa{})(\oenoderefb{}){\poe@key@abspos}{\poe@putlabelrelative{#1}}%
         \fi
      \else
         \ncput[nrot=:U,npos=\poe@key@position]{\poe@putlabelrelative{#1}}
      \fi
      %
      \endgroup
   \fi\fi\fi
   \fi
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FREE-RAY COMPONENTS
%
% DIPOLES
%
\newOptexpDipole{lens}{}%
\newOptexpDipole{pinhole}{}%
\newOptexpDipole{crystal}{}%
\newOptexpDipoleNolabel{polarization}{}%
\newOptexpDipole{optbox}{}%
\newOptexpDipole{optplate}{}%
\newOptexpDipole{optretplate}{}%
\newOptexpDipole[endbox]{optdetector}{}%
\newOptexpDipole{optdiode}{}%
\newOptexpDipole{doveprism}{}%
%
% TRIPOLES
%
\newOptexpTripole{mirror}{}%
\newOptexpTripole[ref@angle=-135]{beamsplitter}{}%
\newOptexpTripole{optgrid}{}%
\newOptexpTripole[ref@angle=-135]{pentaprism}{}%
\newOptexpTripole[ref@angle=-135]{rightangleprism}{}%
\newOptexpTripole[ref@angle=-135]{optprism}{}%
%
% SPECIAL OBJECTS
%
\def\optdipole{\pst@object{optdipole}}
\def\optdipole@i(#1)(#2)#3#4{%
   \begin@OptexpObj
      \ifpoe@bglayer
        \pst@regNodes{#1}{#2}
        \pst@adjustTempNodes
      \fi
      \pst@draw@component{#4}{%
        \ifpoe@bglayer
          \pnode(0,0){\oenodecenter{}}%
          \newOptexpComp{{ 0 0 } { 0 1 } trans {NewPlaneInt} 1 }%
        \fi
        \ifpoe@toplayer
          #3
        \fi
      }%
      \ifpoe@bglayer
        \draw@InternalConnections
      \fi
   \end@OptexpObj
}%
\def\opttripole{\pst@object{opttripole}}
\def\opttripole@i(#1)(#2)(#3)#4#5{%
   \begin@OptexpMultipole
      \pst@calcNodes{#1}{#2}{#3}
      \pst@draw@component{#5}{%
         \pnode(0,0){\oenodecenter{}}% 
         \newOptexpComp{{ 0 0 } { 1 0 } refl {NewPlaneInt} 1 }%
         #4
      }%
      % adjust tempNode@A and tempNode@B for the connections
      % \pnode(##1){tempNode@A}
      % \pnode(##3){tempNode@B}
      % check if node must be switched, therefore we implement this
      % directly as PS code
      \pst@getcoor{#1}\pst@tempA%
      \pst@getcoor{#3}\pst@tempB%
      \pst@OptexpVerb{%
         tx@NodeDict begin
            {\pst@tempA } false chirality 0 le { /N@\oenoderefb{}\space }{ /N@\oenoderefa{}\space } ifelse
             10 {InitPnode } NewNode
             {\pst@tempB } false chirality 0 le { /N@\oenoderefa{}\space }{ /N@\oenoderefb{}\space } ifelse
             10 {InitPnode } NewNode
         end
      }%
      \draw@InternalConnections
   \end@OptexpMultipole
}%
\def\fibercollimator{\pst@object{fibercollimator}}
\def\fibercollimator@i(#1)(#2){%
   \def\pst@tempA{#1}%        
   \def\pst@tempB{#2}%
   \def\pst@tempC{}%
   \def\pst@tempD{}%
   \@ifnextchar({\fibercollimator@ii}{\fibercollimator@iv}%
}%
\def\fibercollimator@ii(#1){%
   \def\pst@tempC{#1}%
   \@ifnextchar({\fibercollimator@iii}{\fibercollimator@iv}%
}%
\def\fibercollimator@iii(#1)#2{%
   \def\pst@tempD{#1}%
   \fibercollimator@iv{#2}%
}
\def\fibercollimator@iv#1{%
  \ifpoe@compat
    \addbefore@par{conn=o-f}%
  \fi
  \addbefore@par{fiberout=both}%
  \begin@OptexpObj
    \pst@regNodes{\pst@tempA}{\pst@tempB}%
    \pst@adjustTempNodes
    \pst@draw@component[fibercollimator]{#1}{%
       \pnode(0,0){\oenodecenter{}}%
       \ifpoe@bglayer
         \fibercollimator@nodes
       \fi
       \ifpoe@toplayer
         \fibercollimator@comp
       \fi
    }%
    \ifpoe@bglayer
      \ifpoe@compat
        \@nameuse{\poe@connIn}
      \else
        \ifpoe@beam
          \drawbeam{(\oenoderefa{})}{\poe@key@compname}
        \fi
      \fi
      \ifpoe@fiberout@
        \ifx\@empty\pst@tempC
          \ifpoe@compat
            \@nameuse{\poe@connOut}
          \else
            \drawfiber{\poe@key@compname}{(\oenoderefb{})}
          \fi
        \else\ifx\@empty\pst@tempD
          \psbezier[style=FiberOut](\pst@tempC)(\pst@tempB)(\pst@tempB)(\oenodeout{})%
        \else
          \psbezier[style=FiberOut](\pst@tempD)(\pst@tempC)(\pst@tempB)(\oenodeout{})%
        \fi\fi
      \fi
    \fi
  \end@OptexpObj
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FIBER COMPONENTS
\newOptexpFiberDipole{optfiber}{}
\newOptexpFiberDipole{optamp}{}
\newOptexpFiberDipole{optmzm}{}
\newOptexpFiberDipole{optfilter}{}
\newOptexpFiberDipole{polcontrol}{}
\newOptexpFiberDipole{optisolator}{}
\newOptexpFiberDipole{optfiberpolarizer}{}
\newOptexpFiberDipole{optswitch}{}
\newOptexpFiberDipole{fiberdelayline}{}
\newOptexpFiberQuadrupole{optcoupler}{}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% default settings
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\psset[optexp]{%
% general
        ,bglayer=true
        ,toplayer=true
        ,position=\@empty
        ,abspos=\@empty
        ,angle=0
        ,rotateref=c
% lens
        ,lenswidth=0
        ,lensheight=1
        ,lensradius=\@empty
        ,lensradiusleft=1
        ,lensradiusright=1
% pinhole
        ,phlinewidth=2\pslinewidth
        ,phwidth=0
        ,outerheight=1
        ,innerheight=0.1
% beamsplitter
        ,bssize=0.8
        ,bsstyle=cube
% crystal
        ,crystalwidth=1.4
        ,crystalheight=0.6
        ,caxislength=0.6
        ,lampscale=0.3
% mirror
        ,mirrorwidth=1
        ,mirrordepth=0.1
        ,mirrorradius=0
        % can't use the \poe@str@mirrortype@plain macro as \define@choicekey
        % does not expand the list containing the alternatives
        ,mirrortype=plain
        ,mirrorlinewidth=2\pslinewidth
        ,variable=false
% optgrid
        ,optgridcount=10
        ,optgridwidth=1
        ,optgridheight=0.15
        ,optgriddepth=0.075
        ,optgridtype=blazed
        ,optgridlinewidth=0.7\pslinewidth
        ,reverse=false
% optbox
        ,optboxwidth=1.4
        ,optboxheight=0.8
% optplate
        ,plateheight=1
        ,platelinewidth=2\pslinewidth
% optretplate
        ,platewidth=0.1
% detector
        ,detsize=0.8
        ,dettype=round
% polarization
        ,poltype=parallel
        ,polsize=0.6
        ,pollinewidth=0.7\pslinewidth
% optdiode
        ,optdiodesize=0.8
% pentaprism
        ,pentaprismsize=0.7
% rightangleprism
        ,raprismsize=1.5
% optprism
        ,prismsize=1
        ,prismangle=60
% doveprism
        ,doveprismsize=0.6
% label
        ,labeloffset=0.8
        ,labelangle=0
        ,labelstyle=\small
        ,labelalign=c
        ,labelref=relgrav
        ,ref@angle=0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% fiber optics
        ,extnode=\@empty
        ,fiberloops=3
        ,fiberloopradius=0.4
        ,fiberloopsep=0.3
        ,optmzmsize=0.8
        ,optampsize=0.8
        ,filtersize=0.8
        ,filtertype=bandpass
        ,polcontrolsize=0.15
        ,isolatorsize=0.6
        ,fiberpolsize=0.6
        ,couplersize=0.2
        ,couplersep=0.05
        ,align=center
        ,coupleroutshift=0
        ,couplertype=elliptic
        ,switchsize=0.8
        ,switchstyle=opened
        ,fdlsize=0.6
        ,fibercolsize=0.3
        ,usefiberstyle=false
        ,bsstyle=cube
        ,compshift=0
        ,n=1.5
% fiber
        ,relangle=false
        ,startnode=auto
        ,stopnode=auto
}%
\poe@insideobjtrue
\psset[optexp]{compname=\@empty}
\poe@insideobjfalse
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% DRAW COMPONENTS
%
% This macro is called by every unit
% The first parameter contains the label, the second one the drawing code
\def\pst@draw@component{%
  \@ifnextchar[%]
    {\pst@draw@component@i}{\pst@draw@component@i[]}%
}%
\def\pst@draw@component@i[#1]#2#3{%
    %
    \def\@@comp{%
       #3%
       \ifx\poe@key@extnode\@empty\else
          \ifpoe@bglayer
            \pnode(! \pst@oe@dict{ExtNode}){\poe@key@extnoden@me}%
          \fi
       \fi
    }%
    \ifpoe@endbox%
       \ifx\poe@key@labeloffset\@empty
          \psset{labeloffset=0}%
       \fi
       \psset{position=1}%
    \fi%
    % 
    \ncline[linestyle=none,fillstyle=none,npos=]{\oenoderefa{}}{\oenoderefb{}}%
    % 
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
    % 
    % Positioning of the component
    % 
    \begingroup
    %   
    \psset{style=OptComp}%
    % 
    % linestyle to use, if component should be marked as optional
    \ifpoe@component@optional
      \psset{style=OptionalStyle}%
    \fi
    % if parameter 'position' is given, use it for 'npos'
    \ifx\poe@key@position\@empty
    % 
    % then check if absolute positioning is wanted
        \ifx\poe@key@abspos\@empty
           \ncput[nrot=:U,npos=]{\poe@putcomp{#1}{\@@comp}}%
        \else
           \nlput[nrot=:U](\oenoderefa{})(\oenoderefb{}){\poe@key@abspos}{\poe@putcomp{#1}{\@@comp}}%
        \fi
    \else
       \ncput[nrot=:U,npos=\poe@key@position]{\poe@putcomp{#1}{\@@comp}}%
    \fi
    \endgroup
    %
    \ifpoe@toplayer
      \poe@putlabel{#2}%
    \fi
    %
    % Show some special dots for debugging
    \ifpoe@debug@showoptdots
      \ifpoe@bglayer
          \psdot[linecolor=green](\oenodecenter{})
          \psdot[linecolor=red](\oenodelabel{})
          \psdot[linecolor=black](\oenoderefa{})
          \psdot[linecolor=black](\oenoderefb{})
      \fi
    \fi
    \ifpoe@debug@showifcnodes
      \ifpoe@bglayer
        \oeifcnodes[linecolor=blue]{\poe@key@b@sicname}
      \fi
    \fi
    %
\ignorespaces}%
\def\oeifcnodes{\pst@object{oeifcnodes}}
\def\oeifcnodes@i#1{%
  \begin@SpecialObj%
  \solid@star%
  \addto@pscode{
    \psk@dotsize
    \@nameuse{psds@\psk@dotstyle}
    \pst@oe@dict{[ (#1) false GetInternalBeamNodes %]
      counttomark 2 idiv { Dot } repeat
      pop}
    }%
  \end@SpecialObj}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\tripole@nodes{%
  \newOptexpComp{ {0 0} {1 0} refl {NewPlaneInt} 1}%
\ignorespaces}%
\def\dipole@nodes{%
  \newOptexpComp{%
    {@@x0 @@x sub 0} {0 1} trans {NewPlaneInt} 
    @@x 0 eq not {
      {@@x0 @@x add 0} {0 1} trans {NewPlaneInt}
    } if \poe@key@n }%
  \pnode(! \pst@oe@dict{@@x0 @@y0}){\oenodecenter{}}
\ignorespaces}%
\def\fiberdipole@nodes{%
  \pnode(! \pst@oe@dict{@@x0 @@x sub 0}){\oenodein{}}
  \pnode(! \pst@oe@dict{@@x0 @@x add 0}){\oenodeout{}}
  \pnode(! \pst@oe@dict{@@x0 @@y0}){\oenodecenter{}}
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% IMPLEMENTATIONS OF ALL ...@iii MACROS
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% MIRROR
%
\def\mirror@ref{%
  \ifx\poe@key@mirrortype\poe@str@mirrortype@piezo
    \pst@OptexpVerb{/@@y0 \pst@number\psyunit def}%
    \bgroup
      \psset{style=PiezoMirror}
      \pst@OptexpVerb{\pst@number\psyunit @@y0 div \poe@key@mirrorwidth\space 0.5 mul mul 2.5 div /@@y0 ED}%
    \egroup
  \else\ifdim\poe@key@mirrorradius pt=0pt
    \pst@OptexpVerb{/@@x \poe@key@mirrorwidth\space 0.5 mul def}%
  \fi\fi
}%
\def\mirror@nodes{%
   \newOptexpComp{{ 0 0 } 
                  \ifdim\poe@key@mirrorradius pt=0pt
                     { 1 0 } refl {NewPlaneInt}
                  \else
                     { 0 \poe@key@mirrorradius\space neg} refl {NewCurvedInt}
                  \fi
                  1 }%
}%
\def\mirror@comp{%
  \edef\@ht{\poe@key@mirrorwidth\space\pst@number\psyunit mul 0.5 mul }%
  \edef\@dp{\poe@key@mirrordepth\space\pst@number\psxunit mul }%
  \edef\@r{\poe@key@mirrorradius\space\pst@number\psxunit mul }%
  \edef\@postcode{neg 5 -1 roll exch 5 2 roll 90 add exch 90 add exch ArcR }%
  \edef\@extpostcode{neg \@dp add 5 -1 roll exch 5 2 roll 90 add exch 90 add }%
  %
  % concave mirrors
  %
  \ifdim\poe@key@mirrorradius pt<0pt
    \ifx\poe@key@mirrortype\poe@str@mirrortype@extended
      % 
      % extended concave mirror
      \bgroup
        \psset{style=ExtendedMirror}
        \begin@ClosedObj
          \addto@pscode{%
            \pst@optexpdict \@ht \@r rightConcave \@postcode  
            \@ht \@r rightConcave \@extpostcode arc
            closepath end}%
        \end@ClosedObj
      \egroup
    \fi
    \begin@OpenObj
      \addto@pscode{\pst@optexpdict \@ht \@r rightConcave \@postcode end}%
    \end@OpenObj
  %
  % convex mirrors
  %
  \else\ifdim\poe@key@mirrorradius pt>0pt
    \ifx\poe@key@mirrortype\poe@str@mirrortype@extended
      % 
      % extended convex mirror
      \bgroup
        \psset{style=ExtendedMirror}
        \begin@ClosedObj
          \addto@pscode{%
            \pst@optexpdict \@ht \@r rightConvex \@postcode
            \@ht \@r rightConvex \@extpostcode arcn
            closepath end}%
        \end@ClosedObj
      \egroup
    \fi
   \begin@OpenObj
     \addto@pscode{\pst@optexpdict \@ht \@r rightConvex \@postcode end}%
   \end@OpenObj
  \else
    % 
    % plain mirror 
    %
    \edef\@ht{\poe@key@mirrorwidth\space 0.5 mul }%
    \ifpoe@variable
      \psarc[style=VariableMirror](! \@ht 0.4 sub 0){0.6}{-20}{20}
      \psarc[style=VariableMirror](! \@ht 0.4 sub neg 0){0.6}{160}{200}
     \fi%
     % 
     % mirrortype
     \ifx\poe@key@mirrortype\poe@str@mirrortype@piezo%
       % 
       % piezo
       \psframe[style=PiezoMirror,dimen=outer](! \@ht 4 div 0)(! \@ht -4 div \@ht 2.5 div)
       \ifx\poe@key@extnode\@empty
         \psbezier(! 0 \@ht 2.5 div)%
                  (! 0 \@ht 1.5 div)%
                  (! \@ht 2 div \@ht 2 div)%
                  (! \@ht 4 div \@ht)%
       \fi
    \else\ifx\poe@key@mirrortype\poe@str@mirrortype@extended%
      % 
      % extended
      \psframe[style=ExtendedMirror]%
         (! \@ht neg \poe@key@mirrordepth\space )%
         (! \@ht 0)%
    \fi\fi
    \psline[linewidth=\poe@key@mirrorlinewidth](! \@ht neg \getCLWH)(! \@ht \getCLWH)
  \fi\fi
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% LENS
%
\def\lens@ref{%
  \pst@OptexpVerb{/@@y \poe@key@lensheight\space 0.5 mul def}%
}%
\def\lens@nodes{%
  \edef\@lens@th{0}% 
  \ifdim\poe@key@lensradiusleft pt=0pt\else
    \edef\@lens@th{\ifpoe@thicklens \poe@key@lenswidth\space 2 div \else \poe@key@lensradiusleft\space\poe@key@lensheight\space 2 div segLen \fi}%     
  \fi
  \ifdim\poe@key@lensradiusright pt=0pt\else
    \edef\@lens@th{\@lens@th\space\ifpoe@thicklens \poe@key@lenswidth\space 2 div\else \poe@key@lensradiusright\space\poe@key@lensheight\space 2 div segLen \fi\space add}%
  \fi
  \newOptexpComp{{\@lens@th\space -2 div 0} 
                  \ifdim\poe@key@lensradiusleft pt=0pt 
                      {0 1} trans {NewPlaneInt}
                   \else 
                      {\poe@key@lensradiusleft\space 0} trans {NewCurvedInt}
                   \fi
                   {\@lens@th\space 2 div 0} 
                   \ifdim\poe@key@lensradiusright pt=0pt
                      {0 1} trans {NewPlaneInt}
                   \else
                      {\poe@key@lensradiusright\space neg 0} trans {NewCurvedInt} 
                   \fi
                   \poe@key@n}%
}%
\def\lens@comp{%
  \addbefore@par{linejoin=1}%
  \begin@ClosedObj
  \edef\@lens@newwd{0 }%
  \edef\@lens@wd{\poe@key@lenswidth\space\pst@number\psxunit mul 2 div }%
  \edef\@lens@th{0}%
  \addto@pscode{%
    \pst@optexpdict
    /@wd \poe@key@lenswidth\space\pst@number\psxunit mul 2 div def
    /@ht \poe@key@lensheight\space\pst@number\psyunit mul 2 div def
    /@rL \poe@key@lensradiusleft\space\pst@number\psxunit mul def
    /@rR \poe@key@lensradiusright\space\pst@number\psxunit mul def
    /@th 0 def	
  }%
  % 
  % distinguish between all the different lens-combination possibilities
  \ifdim\poe@key@lensradiusleft pt=0pt\else
    % this takes the /a1 definition from the leftC* procedures
    % the macro is necessary for the outer nodes
    \edef\@lens@newwd{%
      \poe@key@lensradiusleft\space\poe@key@lensheight\space 2 div segLen
      \ifdim\poe@key@lensradiusleft pt<0pt
        0.5 mul\space
      \fi
    }%
    \edef\@lens@th{%
      \ifpoe@thicklens
        \poe@key@lenswidth\space 2 div 
      \else
        \poe@key@lensradiusleft\space\poe@key@lensheight\space 2 div segLen
      \fi
    }%
    \addto@pscode{%
      /@th \ifpoe@thicklens @wd \else @rL @ht segLen \fi def
      @ht @rL
      \ifdim\poe@key@lensradiusleft pt<0pt
        leftConcave
      \else
        leftConvex
      \fi
    }%
  \fi
  \ifdim\poe@key@lensradiusright pt=0pt\else
    % this takes the /a1 definition from the rightC* procedures
    % the macro is necessary for the outer nodes
    \edef\@lens@th{%
      \@lens@th\space
      \ifpoe@thicklens 
        \poe@key@lenswidth\space 2 div
      \else
        \poe@key@lensradiusright\space\poe@key@lensheight\space 2 div segLen 
      \fi\space add
    }%
    \addto@pscode{%
      /@th @th \ifpoe@thicklens @wd \else @rR @ht segLen \fi add def
      @ht @rR
      \ifdim\poe@key@lensradiusright pt<0pt
        rightConcave
      \else
        rightConvex
      \fi
    }%
  \fi
  % 
  % check some special cases
  % 
  % 1) Left is plain - right concave / convex
  \ifdim\poe@key@lensradiusleft pt=0pt
    \ifdim\poe@key@lensradiusright pt=0pt\else
      \addto@pscode{%
        @th 2 div sub neg 5 1 roll
        @th 2 div neg @ht neg moveto ArcR
        @th 2 div neg @ht lineto
      }%
    \fi
  \fi
  %
  % 2) Right is plain - left concave / convex
  \ifdim\poe@key@lensradiusright pt=0pt
    \ifdim\poe@key@lensradiusleft pt=0pt\else
      \addto@pscode{%
        @th 2 div sub 5 1 roll
        @th 2 div @ht moveto ArcL
        @th 2 div @ht neg lineto
      }%
    \fi
  \fi
  % 
  % 3) right and left are both curved
  \ifdim\poe@key@lensradiusright pt=0pt\else
    \ifdim\poe@key@lensradiusleft pt=0pt\else
      \addto@pscode{%
        @th 2 div dup
        7 1 roll sub neg 5 1 roll
        ArcR sub 5 1 roll ArcL
      }%
    \fi
  \fi
  % 
  % now complete the object
  \addto@pscode{closepath 1 setlinejoin end }%
  \end@ClosedObj
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% PINHOLE
%
\def\pinhole@ref{%
  \pst@OptexpVerb{/@@y \poe@key@outerheight\space 0.5 mul def}%
\ignorespaces}%
\def\pinhole@comp{%
  \ifdim\poe@key@phwidth pt=0pt
    \psline[linewidth=\poe@key@phlinewidth]%
           (! 0 \poe@key@outerheight\space 2 div)%
           (! 0 \poe@key@innerheight\space 2 div)%
    \psline[linewidth=\poe@key@phlinewidth]%
           (! 0 \poe@key@outerheight\space -2 div)%
           (! 0 \poe@key@innerheight\space -2 div)%
  \else
    \pspolygon*[linestyle=none](! 0 \poe@key@innerheight\space 2 div)%
               (! 0 \poe@key@outerheight\space 2 div)%
               (! \poe@key@phwidth\space \poe@key@outerheight\space 2 div)%
               (! \poe@key@phwidth\space \poe@key@innerheight\space dup neg \poe@key@outerheight\space add 2 div add 2 div)%
    \pspolygon*[linestyle=none](! 0 \poe@key@innerheight\space -2 div)%
               (! 0 \poe@key@outerheight\space -2 div)%
               (! \poe@key@phwidth\space \poe@key@outerheight\space -2 div)%
               (! \poe@key@phwidth\space \poe@key@innerheight\space dup neg \poe@key@outerheight\space add 2 div add -2 div)%
  \fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% BEAMSPLITTER
%
\def\beamsplitter@nodes{%
  \edef\@bs@wd{\poe@key@bssize\space 2.0 div }%
  \ifx\poe@key@bsstyle\poe@str@bsstyle@cube
    \ifpoe@compat
      % the old beamsplitter had only one defined plane
      \newOptexpCompAmb{ {0 0} {1 0} trans {NewPlaneInt} 1 }%
    \else
      \newOptexpCompAmb{ {\@bs@wd 2 sqrt div neg dup} {-1 1} trans {NewPlaneInt}
                         {\@bs@wd 2 sqrt div dup neg} {1 1} trans {NewPlaneInt}
                         {\@bs@wd 2 sqrt div dup} {-1 1} trans {NewPlaneInt}
                         {\@bs@wd 2 sqrt div neg dup neg} {1 1} trans {NewPlaneInt} 
                         {0 0} {1 0} trans {NewPlaneInt} \poe@key@n}%
    \fi
  \else\ifx\poe@key@bsstyle\poe@str@bsstyle@plate
    \newOptexpCompAmb{ {0 0} {1 0} trans {NewPlaneInt} 1 }%
  \fi\fi
\ignorespaces}%
\def\beamsplitter@comp{%
  \edef\@bs@wd{\poe@key@bssize\space 2.0 div }%
  \ifx\poe@key@bsstyle\poe@str@bsstyle@cube
    \psline{cc-cc}(! \@bs@wd neg 2 sqrt mul 0)(! \@bs@wd 2 sqrt mul 0)
    \rput[c]{45}(0,0){\psframe(! \@bs@wd neg \@bs@wd neg)(! \@bs@wd \@bs@wd)}
  \else\ifx\poe@key@bsstyle\poe@str@bsstyle@plate
    \psline(! \@bs@wd neg 2 sqrt mul 0)(! \@bs@wd 2 sqrt mul 0)
  \fi\fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% CRYSTAL
%
\def\crystal@ref{%
  \let\poe@key@optboxwidth\poe@key@crystalwidth
  \let\poe@key@optboxheight\poe@key@crystalheight
  \optbox@ref
}%
\def\crystal@comp{%
  \edef\@wd{\poe@key@crystalwidth\space 0.5 mul }
  \edef\@ht{\poe@key@crystalheight\space 0.5 mul }
  \psframe(! \@wd neg \@ht neg)(! \@wd \@ht)
  \ifpoe@voltage%
    \psline(!\@wd 4 div 3 mul neg \@ht)(! \@wd 4 div 3 mul neg \@ht 0.2 add)
    \pscircle[fillstyle=solid, fillcolor=white](! \@wd 4 div 3 mul neg \@ht 0.2 add){0.04}
    \psline(! \@wd 4 div 3 mul neg \@ht neg)%
           (! \@wd 4 div 3 mul neg \@ht neg 0.2 sub)%
    \psline(! \@wd 4 div 3 mul neg 0.15 sub \@ht neg 0.2 sub)%
           (! \@wd 4 div 3 mul neg 0.15 add \@ht neg 0.2 sub)%
  \fi
  \ifpoe@lamp
    \rput{180}(! \@wd \@ht 1.4 \poe@key@lampscale\space mul add){\crystal@lamp}%
  \fi
  \ifdim\poe@key@caxislength pt>0pt
    \edef\@c@caxisL{\poe@key@caxislength\space 2 div }%
    \ifpoe@caxisinv
      % invert the c-axis
      \psline[style=CrystalCaxis](! 0 \@ht neg)(! 0 \@ht \@c@caxisL add)%
    \else
      \psline[style=CrystalCaxis](! 0 \@ht)(! 0 \@ht neg \@c@caxisL sub)%
    \fi
  \fi
\ignorespaces}%
%
% LAMP FOR THE CRYSTAL
\def\crystal@lamp{%
  \psset{linewidth=0.6\pslinewidth}
  \edef\@sz{\poe@key@lampscale\space}%
  \pscurve[fillstyle=none](! -0.05 \@sz mul 0)%
          (! -0.1 \@sz mul 0.15 \@sz mul)%
          (! -0.2 \@sz mul 0.25 \@sz mul)%
          (! -0.25 \@sz mul 0.5 \@sz mul)%
          (! 0 0.7 \@sz mul)%
          (! 0.25 \@sz mul 0.5 \@sz mul)%
          (! 0.2 \@sz mul 0.25 \@sz mul)%
          (! 0.1 \@sz mul 0.15 \@sz mul)%
          (! 0.05 \@sz mul 0)
  \multido{\i=-210+40}{7}{%
    \rput{\i}(! 0 0.45 \@sz mul){\psline(! -0.35 \@sz mul 0)(! -0.6 \@sz mul 0)}
  }%
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% POLARIZATION
%
\def\polarization@comp{%
  \edef\@pol@size{\poe@key@polsize\space 0.5 mul }%
  \ifx\poe@key@poltype\poe@str@pol@polparallel
    \psline[linestyle=solid, linewidth=\poe@key@pollinewidth, arrowscale=0.8]{<->}(! 0 \@pol@size neg)(! 0 \@pol@size)%
  \fi
  \ifx\poe@key@poltype\poe@str@pol@polperp
    \psdot[dotsize=0.05](0,0)%
    \pscircle[fillstyle=none,linestyle=solid,linewidth=\poe@key@pollinewidth](0,0){0.12}%
  \fi
  \ifx\poe@key@poltype\poe@str@pol@polmisc
    \psline[linestyle=solid,linewidth=\poe@key@pollinewidth,arrowscale=0.8]{<->}(! 0 \@pol@size neg)(! 0 \@pol@size)%
    \psdot[dotsize=0.05](0,0)%
    \pscircle[fillstyle=none,linestyle=solid,linewidth=0.7\pslinewidth](0,0){0.12}%
  \fi
  \ifx\poe@key@poltype\poe@str@pol@polrcirc
    \psellipticarc[linewidth=\poe@key@pollinewidth]{->}(0,0)(! \@pol@size 2 div \@pol@size){20}{-20}%
  \fi
  \ifx\poe@key@poltype\poe@str@pol@pollcirc
    \psellipticarc[linewidth=\poe@key@pollinewidth]{<-}(0,0)(! \@pol@size 2 div \@pol@size){20}{-20}
  \fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTICAL GRID
%
\def\optgrid@ref{%
  \pst@OptexpVerb{/@@y0 \poe@key@optgridheight\space def
                  /@@x \poe@key@optgridwidth\space 0.5 mul def}%
}%
\def\optgrid@comp{%
  \edef\@cnt{\poe@key@optgridcount\space}%
  \edef\@wd{\poe@key@optgridwidth\space 2 div }%
  \edef\@ht{\poe@key@optgridheight\space}%
  \edef\@dp{\poe@key@optgriddepth\space}%
  \edef\@step{\poe@key@optgridwidth\space\@cnt div }%
  \ifx\poe@key@optgridtype\poe@str@optgridtype@blazed
    \pscustom[linewidth=\poe@key@optgridlinewidth, linejoin=1]{%
      \psline[liftpen=1](! \@wd \@dp)(! \@wd \@ht)%
                        (! \@wd neg \@ht)(! \@wd neg \@dp)
      \multido{\i=0+1}{\poe@key@optgridcount}{%
        \psline[liftpen=1](! \@wd neg \i\space \@step mul add \@dp)%
                          (! \@wd neg \i\space \ifpoe@reverse\else 1 add \fi \@step mul add 0)%
                          (! \@wd neg \i\space 1 add \@step mul add \@dp)%
      }%
      \closepath
    }%
  \else\ifx\poe@key@optgridtype\poe@str@optgridtype@binary
    \pscustom[linewidth=\poe@key@optgridlinewidth]{%
      \psline[liftpen=1](! \@wd \@dp)(! \@wd \@ht)%
                        (! \@wd neg \@ht)(! \@wd neg \@dp)
      \multido{\i=0+1}{\poe@key@optgridcount}{%
        \psline[liftpen=1](! \@wd neg \i\space \@step mul add \@dp)%
                          (! \@wd neg \i\space \@step mul add 0)%
                          (! \@wd neg \i\space 0.5 add \@step mul add 0)%
                          (! \@wd neg \i\space 0.5 add \@step mul add \@dp)%
                          (! \@wd neg \i\space 1 add \@step mul add \@dp)%
      }%
    }%
  \fi\fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTBOX
%
\def\optbox@ref{%
  \pst@OptexpVerb{%
    /@@x \poe@key@optboxwidth\space 0.5 mul def
    /@@y \poe@key@optboxheight\space 0.5 mul def
  }%
  \ifpoe@endbox
    \pst@OptexpVerb{/@@x0 @@x def}%
  \fi
}%
\def\optbox@comp{%
  \edef\@wd{\poe@key@optboxwidth\space 0.5 mul }
  \edef\@ht{\poe@key@optboxheight\space 0.5 mul }
  \ifpoe@endbox
    \psframe[dimen=outer](! 0 \@ht neg)(! \@wd 2 mul \@ht)
  \else
    \psframe[dimen=outer](! \@wd neg \@ht neg)(! \@wd \@ht)
  \fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTPLATE
%
\def\optplate@ref{%
  \pst@OptexpVerb{/@@y \poe@key@plateheight\space 0.5 mul def }%
}%
\def\optplate@comp{%
   \psline[linewidth=\poe@key@platelinewidth](! \pst@oe@dict{0 @@y neg})(! \pst@oe@dict{0 @@y})
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% DETECTOR
%
\def\optdetector@ref{%
  \pst@OptexpVerb{/@@x0 \poe@key@detsize\space 0.5 mul def}%
  \ifx\poe@key@dettype\poe@str@dettype@diode
    \pst@OptexpVerb{ @@x0 dup /@@x ED /@@y ED}%
  \fi
}%
\def\optdetector@nodes{%
  \newOptexpComp{{ 0 0} { 0 1 } refl {NewPlaneInt} 1 }%
  \ifx\poe@key@dettype\poe@str@dettype@round
    \pnode(! \poe@key@detsize\space 0.2 mul 0){\oenodecenter{}}%
  \else\ifx\poe@key@dettype\poe@str@dettype@diode
    \pnode(! \poe@key@detsize\space 0.5 mul 0){\oenodecenter{}}
  \fi\fi
}%
\def\optdetector@comp{%
   \pnode(\oenoderefb{}){\oenodein{}}
   \ifx\poe@key@dettype\poe@str@dettype@round
      \begin@ClosedObj
         % I could have use pswedge but then a correction of the component size
         % depending on the current linewidth is not possible
         \addto@pscode{CLW 0.5 mul 0 \poe@key@detsize\space\pst@number\psrunit mul 0.5 mul 
            CLW sub -90 90 arc closepath }%
      \end@ClosedObj
   \else\ifx\poe@key@dettype\poe@str@dettype@diode
      \edef\@sz{\poe@key@detsize\space 0.5 mul }%
      \psframe[dimen=outer](! 0 \@sz neg)(!\@sz 2 mul \@sz)
      \pspolygon(! \@sz 0.8 mul \@sz -0.4 mul)%
             (! \@sz 1.6 mul \@sz -0.4 mul)%
             (! \@sz 1.2 mul \@sz 0.4 mul)%
      \psline(! \@sz 0.8 mul \@sz 0.4 mul \getCLWH add)(! \@sz 1.6 mul \@sz 0.4 mul \getCLWH add)
      \psset{arrows=->, arrowinset=0, arrowscale=0.8}
      \psline(! \@sz 0.2 mul \@sz 0.3 mul)(! \@sz 0.7 mul \@sz 0.15 mul)
      \psline(! \@sz 0.2 mul 0)(! \@sz 0.7 mul \@sz -0.15 mul)
   \fi\fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTRETPLATE
%
\def\optretplate@ref{%
   \pst@OptexpVerb{%
     /@@y \poe@key@plateheight\space 0.5 mul def
     /@@x \poe@key@platewidth\space 0.5 mul def
   }%
}%
\def\optretplate@comp{%
   \edef\@ht{\poe@key@plateheight\space 0.5 mul }%
   \edef\@wd{\poe@key@platewidth\space 0.5 mul }%
   \psframe(! \@wd neg \@ht neg)(! \@wd \@ht)
   \psline{cc-cc}(! \@wd neg \@ht)(! \@wd \@ht neg)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTDIODE
%
\def\optdiode@ref{%
   \pst@OptexpVerb{\poe@key@optdiodesize\space 0.5 mul dup /@@y ED /@@x ED }%
}%
\def\optdiode@comp{%
   \edef\@sz{\poe@key@optdiodesize\space}%
   \psframe[dimen=outer](! \@sz -0.5 mul dup)(!\@sz 0.5 mul dup)
   \pspolygon(! \@sz -0.2 mul \@sz -0.2 mul)
             (! \@sz -0.2 mul \@sz 0.2 mul)
             (! \@sz 0.2 mul 0)
   \psline(! \@sz 0.2 mul \getCLWH add \@sz 0.2 mul)(! \@sz 0.2 mul \getCLWH add \@sz -0.2 mul)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% DOVE PRISM
%
\def\doveprism@nodes{%
  \newOptexpComp{ {\poe@key@doveprismsize\space neg 0} {1 1} trans {NewPlaneInt}
                  {0 \poe@key@doveprismsize\space -0.5 mul} {1 0} refl {NewPlaneInt}
                  {\poe@key@doveprismsize\space 0} {-1 1} trans {NewPlaneInt} \poe@key@n }%
\ignorespaces}%
\def\doveprism@comp{%
   \edef\@ht{\poe@key@doveprismsize\space 0.5 mul }%
   \edef\@wd{\poe@key@doveprismsize\space 1.5 mul }%
   \pspolygon(! \@wd neg \@ht neg)%
             (! \@wd \@ht neg)%
             (! \@ht dup)%
             (! \@ht neg \@ht)%
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% PENTA PRISM
%
\def\pentaprism@nodes{%
  \edef\@pp@size{\poe@key@pentaprismsize\space}%
  \newOptexpComp{ {\@pp@size 2 sqrt -2 mul div dup } {-1 1} trans {NewPlaneInt}
                  {\@pp@size 2 sqrt div 67.5 cos \@pp@size mul 67.5 sin 2 mul div sub \@pp@size 2 div}
                  { 67.5 cos \@pp@size mul 67.5 sin div neg \@pp@size} refl {NewPlaneInt}
                  {\@pp@size 2 sqrt div neg 67.5 cos \@pp@size mul 67.5 sin 2 mul div add \@pp@size 2 div}
                  { 67.5 cos \@pp@size mul 67.5 sin div \@pp@size} refl {NewPlaneInt}
                  {\@pp@size 2 sqrt 2 mul div dup neg} {1 1} trans {NewPlaneInt} \poe@key@n}%   
}%
\def\pentaprism@comp{%
   \edef\@pp@size{\poe@key@pentaprismsize\space}%
   \pscustom{%
      \psline(! \@pp@size 2 sqrt div 0)%
         (! \@pp@size 2 sqrt div 67.5 cos \@pp@size mul 67.5 sin div sub \@pp@size)%
         (! 67.5 cos \@pp@size mul 67.5 sin div \@pp@size 2 sqrt div sub \@pp@size)%
         (! \@pp@size 2 sqrt div neg 0)%
         (! 0 \@pp@size 2 sqrt div neg)%
      \closepath
   }%
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% PRISM
%
\def\optprism@nodes{%
   \edef\@sz{\poe@key@prismsize\space}%
   \edef\@altan{\poe@key@prismangle\space 0.5 mul tan }%
   \edef\@hshift{\@sz 0.6 mul \@altan mul \pst@optexpdict OEangle end 0.5 mul tan div }%
   \newOptexpComp{ {\@sz -0.6 mul \@altan mul \@hshift neg} {90 \poe@key@prismangle\space 0.5 mul sub dup cos exch sin} trans {NewPlaneInt}
                   {\@sz 0.6 mul \@altan mul \@hshift neg} {90 \poe@key@prismangle\space 0.5 mul add dup cos exch sin} trans {NewPlaneInt} \poe@key@n }%
}%
\def\optprism@comp{%
   \edef\@sz{\poe@key@prismsize\space}%
   \edef\@altan{\poe@key@prismangle\space 0.5 mul tan }%
   \edef\@hshift{\@sz 0.6 mul \@altan mul \pst@optexpdict OEangle end 0.5 mul tan div }%
   \pspolygon(! \@sz neg \@altan mul \@sz -0.4 mul \@hshift sub)
             (! \@sz \@altan mul \@sz -0.4 mul \@hshift sub)
             (! 0 \@sz 0.6 mul \@hshift sub)
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% RIGHT-ANGLE PRISM
%
\def\rightangleprism@nodes{%
  \edef\@sz{\poe@key@raprismsize\space 0.5 mul }%
  \edef\@ht{\pst@oe@dict{OEangle 0.5 mul sin modA mul} }%
  \newOptexpComp{ {\@ht neg \@ht \@sz sub} {1 0} trans {NewPlaneInt}
                  {\@ht neg 0} {1 1} refl {NewPlaneInt}
                  {\@ht 0} {1 -1} refl {NewPlaneInt}
                  {\@ht dup \@sz sub } {1 0} trans {NewPlaneInt} \poe@key@n }%
\ignorespaces}%
\def\rightangleprism@comp{%
  \edef\@sz{\poe@key@raprismsize\space 0.5 mul }%
  \edef\@ht{\pst@oe@dict{OEangle 0.5 mul sin modA mul} }%
  \pspolygon(! \@sz neg \@ht \@sz sub)
            (! \@sz \@ht \@sz sub)
            (! 0 \@ht)%
\ignorespaces}%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FIBER OPTICS
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FIBER
%
% there is no need to separate into @nodes and @comp macros
\def\optfiber@iii{%
   \edef\@f@cnt{\poe@key@fiberloops\space}%
   \edef\@f@r{\poe@key@fiberloopradius\space}%
   \edef\@f@sep{\poe@key@fiberloopsep\space}%
   \parametricplot[plotpoints=200,style=Fiber]{0}{1}{%
      t 360 mul \@f@cnt mul sin \@f@r mul \@f@sep \@f@cnt 1 sub mul t 0.5 sub mul add
      1 t 360 mul \@f@cnt mul cos sub \@f@r mul
   }%
   \pnode(! \@f@sep \@f@cnt 1 sub mul -0.5 mul 0){\oenodein{}}
   \pnode(! \@f@sep \@f@cnt 1 sub mul 0.5 mul 0){\oenodeout{}}
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTMZM
%
\def\optmzm@ref{%
  \pst@OptexpVerb{\poe@key@optmzmsize\space dup 0.8 mul /@@x ED 0.5 mul /@@y ED }%
}%
\def\optmzm@comp{%
  \def\@wd{\poe@key@optmzmsize\space 0.8 mul }%
  \def\@ht{\poe@key@optmzmsize\space 0.5 mul }%
  \bgroup
    \ifpoe@usefiberstyle
      \psset{style=Fiber}
    \fi
    \psline(! \@wd neg 0)(! \@wd -0.7 mul 0)(! \@wd -0.4 mul \@ht 0.6 mul)%
           (! \@wd 0.4 mul \@ht 0.6 mul)(! \@wd 0.7 mul 0)(! \@wd 0)%
           (! \@wd 0.7 mul 0)(! \@wd 0.4 mul \@ht -0.6 mul)%
           (! \@wd -0.4 mul \@ht -0.6 mul)(! \@wd -0.7 mul 0)%
  \egroup
  \psframe[dimen=outer](! \@wd neg \@ht neg)(! \@wd \@ht)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTICAL FILTER
%
\def\optfilter@ref{%
  \pst@OptexpVerb{\poe@key@filtersize\space 0.5 mul dup /@@y ED /@@x ED }%
}%
\def\optfilter@comp{%
  \edef\@sz{\poe@key@filtersize\space 0.5 mul }%
  \def\filter@curve{%
    \parametricplot[plotstyle=curve,arrows=c-c]{-1}{1}{%
      t \@sz mul 0.7 mul t Pi mul RadtoDeg 90 add cos 0.2 \@sz mul mul}%
  }%
  \psframe[dimen=outer](! \@sz neg dup)(! \@sz dup)
  \ifx\poe@key@filtertype\poe@str@filtertype@bandpass
    \psline(! -0.3 \@sz mul -0.65 \@sz mul)%
           (! 0.3 \@sz mul -0.35 \@sz mul)%
    \psline(! -0.3 \@sz mul 0.35 \@sz mul)%
           (! 0.3 \@sz mul 0.65 \@sz mul)%
    \rput(! 0 -0.5 \@sz mul){\filter@curve}
    \rput(0, 0){%
      \ifpoe@usefiberstyle
        \psset{style=Fiber}
      \fi
      \filter@curve}
    \rput(! 0 0.5 \@sz mul){\filter@curve}
  \else\ifx\poe@key@filtertype\poe@str@filtertype@bandstop
    \psline(! -0.3 \@sz mul -0.15 \@sz mul)%
           (! 0.3 \@sz mul 0.15 \@sz mul)%
    \rput(! 0 -0.5 \@sz mul){%
      \ifpoe@usefiberstyle
        \psset{style=Fiber}
      \fi
      \filter@curve}
      \rput(0, 0){\filter@curve}
      \rput(! 0 0.5 \@sz mul){%
        \ifpoe@usefiberstyle
          \psset{style=Fiber}
        \fi
        \filter@curve}
  \else\ifx\poe@key@filtertype\poe@str@filtertype@lowpass
    \psline(! -0.3 \@sz mul -0.15 \@sz mul)%
           (! 0.3 \@sz mul 0.15 \@sz mul)%
    \psline(! -0.3 \@sz mul 0.35 \@sz mul)%
           (! 0.3 \@sz mul 0.65 \@sz mul)%
    \rput(! 0 -0.5 \@sz mul){%
      \ifpoe@usefiberstyle
        \psset{style=Fiber}
      \fi
      \filter@curve}
      \rput(0, 0){\filter@curve}
      \rput(! 0 0.5 \@sz mul){\filter@curve}
  \else\ifx\poe@key@filtertype\poe@str@filtertype@highpass
    \psline(! -0.3 \@sz mul -0.15 \@sz mul)%
           (! 0.3 \@sz mul 0.15 \@sz mul)%
    \psline(! -0.3 \@sz mul -0.65 \@sz mul)%
           (! 0.3 \@sz mul -0.35 \@sz mul)%
    \rput(! 0 0.5 \@sz mul){%
      \ifpoe@usefiberstyle
        \psset{style=Fiber}
      \fi
      \filter@curve}
      \rput(0, 0){\filter@curve}
      \rput(! 0 -0.5 \@sz mul){\filter@curve}
  \fi\fi\fi\fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTICAL AMPLIFIER
%
\def\optamp@nodes{%
  \edef\@sz{\poe@key@optampsize\space 0.5 mul }%
  \edef\@xl{0.75 sqrt \@sz mul }%
  \pnode(!\@xl neg 0){\oenodein{}}
  \pnode(!\@xl 0){\oenodeout{}}  
}%
\def\optamp@comp{%
  \edef\@sz{\poe@key@optampsize\space 0.5 mul }%
  \edef\@xl{0.75 sqrt \@sz mul }%
  \pspolygon(! \@xl 0)(! \@xl neg \@sz)(! \@xl neg \@sz neg)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% POLARIZATION CONTROLLER
%
\def\polcontrol@comp{%
   \edef\@sz{\poe@key@polcontrolsize\space}%
   \ifpoe@usefiberstyle
      \psset{style=Fiber}
   \fi
   \multips(! -2 \@sz mul \@sz)(! 2 \@sz mul 0){3}{\pscircle(0,0){\poe@key@polcontrolsize}}
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% ISOLATOR
%
\def\optisolator@ref{%
  \pst@OptexpVerb{\poe@key@isolatorsize\space dup 0.8 mul /@@x ED 0.5 mul /@@y ED }%
}%
\def\optisolator@comp{%
  \edef\@ht{\poe@key@isolatorsize\space 0.5 mul }%
  \edef\@wd{\poe@key@isolatorsize\space 0.8 mul }%
  \psframe[dimen=outer](! \@wd neg \@ht neg)(! \@wd \@ht)
  \psline[style=IsolatorArrow]{->}(! \@wd neg 0.6 mul 0)(!\@wd 0.6 mul 0)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FIBER POLARIZER
%
\def\optfiberpolarizer@ref{%
  \pst@OptexpVerb{\poe@key@fiberpolsize\space dup 0.8 mul /@@x ED 0.5 mul /@@y ED }%
}%
\def\optfiberpolarizer@comp{%
  \edef\@ht{\poe@key@fiberpolsize\space 0.5 mul }%
  \edef\@wd{\poe@key@fiberpolsize\space 0.8 mul }%
  \psframe[dimen=outer](! \@wd neg \@ht neg)(! \@wd \@ht)
  \psline(! \@wd neg 0.2 mul \@ht neg)(!\@wd 0.2 mul \@ht)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% SWITCH
%
\def\optswitch@ref{%
  \pst@OptexpVerb{\poe@key@switchsize\space 0.5 mul dup /@@y ED /@@x ED }%
}%
\def\optswitch@comp{%
  \edef\@sz{\poe@key@switchsize\space 0.5 mul }%
  % storing the linewidth of the object allows for some aesthetic fine tuning 
  \pstVerb{tx@Dict begin /@lw \getCLW def end}%
  % the fiber parts
  \bgroup
    \ifpoe@usefiberstyle
      \psset{style=Fiber}
    \fi
    \psline[arrows=-](! \@sz neg 0)(! \@sz -0.6 mul @lw sub 0)%
    \psline[arrows=-](! \@sz 0.6 mul 0)(! \@sz 0)%
  \egroup
  % different styles
  \ifx\poe@key@switchstyle\poe@str@closed%
    \bgroup
      \ifpoe@usefiberstyle
        \psset{style=Fiber}
      \fi
      \psdot[dotsize=3\pslinewidth](! \@sz 0.6 mul 0)%
      \psdot[dotsize=3\pslinewidth](! \@sz -0.6 mul 0)%
      \psline[arrows=-, linewidth=1.5\pslinewidth](! \@sz -0.6 mul @lw)(! \@sz 0.6 mul @lw)%      
    \egroup
  \else
    \psline[arrows=-, linewidth=1.5\pslinewidth](! \@sz -0.6 mul @lw add @lw)(! \@sz 0.6 mul dup)%
    \pscircle(! \@sz -0.6 mul 0){\pslinewidth}%
    \psdot[dotsize=3\pslinewidth](! \@sz 0.6 mul 0)%
  \fi
  \psframe[dimen=outer](! \@sz neg dup)(! \@sz dup)%
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FIBER DELAY LINE
%
\def\fiberdelayline@ref{%
  \pst@OptexpVerb{\poe@key@fdlsize\space dup 0.8 mul /@@x ED 0.5 mul /@@y ED }%
}%
\def\fiberdelayline@comp{%
  \def\@wd{\poe@key@fdlsize\space 0.8 mul }%
  \def\@ht{\poe@key@fdlsize\space 0.5 mul }%
  \psframe[dimen=outer](! \@wd neg \@ht neg)(! \@wd \@ht)
  \psline[style=FdlArrow](! \@wd -0.3 mul \@ht -1.5 mul)(! \@wd 0.3 mul \@ht 1.2 mul CLW \pst@number\psyunit div 5 mul add)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% COUPLER
%
\def\optcoupler@nodes{%
  \edef\@sz{\poe@key@couplersize\space}%
  \edef\@sep{\poe@key@couplersep\space 0.5 mul }%
  \ifx\poe@key@align\poe@str@top
    \def\@yshift{\@sep neg }%
  \else\ifx\poe@key@align\poe@str@bottom
    \def\@yshift{\@sep\space}%
  \else
    \def\@yshift{0 }%
  \fi\fi
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \pnode(! \@sz -0.5 mul \@yshift \@sep add){\oenode{}{1}}
    \pnode(! \@sz -0.5 mul \@yshift \@sep sub){\oenode{}{2}}
    \pnode(! \@sz 0.5 mul \@yshift \@sep add){\oenode{}{3}}
    \pnode(! \@sz 0.5 mul \@yshift \@sep sub){\oenode{}{N}}
  \else
    \pnode(! \@sz neg \getCLW 0.3 mul add \@yshift \@sep add){\oenode{}{1}}
    \pnode(! \@sz neg \getCLW 0.3 mul add \@yshift \@sep sub){\oenode{}{2}}
    \pnode(! \@sz \getCLW 0.3 mul sub \@yshift \@sep add){\oenode{}{3}}
    \pnode(! \@sz \getCLW 0.3 mul sub \@yshift \@sep sub){\oenode{}{N}}
  \fi
  \pnode(! 0 \@yshift){\oenodecenter{}}
}%
\def\optcoupler@comp{%
  \edef\@sz{\poe@key@couplersize\space}%
  \edef\@sep{\poe@key@couplersep\space 0.5 mul }%
  \ifx\poe@key@align\poe@str@top
    \def\@yshift{\@sep neg }%
  \else\ifx\poe@key@align\poe@str@bottom
    \def\@yshift{\@sep\space}%
  \else
    \def\@yshift{0 }%
  \fi\fi
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \psline[style=Fiber](\oenode{}{1})(\oenode{}{3})
    \psline[style=Fiber](\oenode{}{2})(\oenode{}{N})
  \else\ifx\poe@key@couplertype\poe@str@couplertype@elliptic
    \psellipse[dimen=outer](!0 \@yshift)(! \@sz \@sz 0.4 mul)
  \else\ifx\poe@key@couplertype\poe@str@couplertype@rectangular
    \psframe[dimen=outer](!\@sz neg \@yshift \@sz 0.4 mul sub )%
                         (!\@sz \@yshift \@sz 0.4 mul add)
  \else\ifx\poe@key@couplertype\poe@str@couplertype@crossswitch
    \psframe[dimen=outer](!\@sz neg \@yshift \@sz sub )%
                         (!\@sz \@yshift \@sz add)
    \edef\@csz{\poe@key@couplersize\space 0.5 mul }
    \psline(! \@csz neg dup)(! \@csz dup)
    \psline(! \@csz neg \@csz)(! \@csz dup neg)
  \fi\fi\fi\fi
  \ifpoe@variable
    \psline[style=VariableCoupler](!\@sz -0.5 mul \@sz neg \@yshift add)(!\@sz 0.5 mul \@sz \@yshift add)
  \fi
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% WDM COUPLER
%
\def\wdmcoupler@nodes{%
  \edef\@sz{\poe@key@couplersize\space}%
  \edef\@sep{\poe@key@couplersep\space 0.5 mul }%
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \ifx\poe@key@align\poe@str@center
      \edef\@sep{0 }%
    \fi
  \fi
  %
  \ifx\poe@key@align\poe@str@top
    \def\@yshift{\@sep neg }%
  \else\ifx\poe@key@align\poe@str@bottom
    \def\@yshift{\@sep }%
  \else
    \def\@yshift{0 }%
  \fi\fi
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \pnode(! \@sz -0.5 mul \@yshift \@sep add){\oenode{}{1}}
    \pnode(! \@sz -0.5 mul \@yshift \@sep sub){\oenode{}{2}}
    \pnode(! \@sz 0.5 mul 0){\oenode{}{N}}
  \else
    \pnode(! \@sz neg \getCLW 0.3 mul add \@yshift \@sep add){\oenode{}{1}}
    \pnode(! \@sz neg \getCLW 0.3 mul add \@yshift \@sep sub){\oenode{}{2}}
    \pnode(! \@sz \getCLW 0.3 mul sub 0){\oenode{}{N}}
  \fi
  \pnode(! 0 \@yshift){\oenodecenter{}}
}%
\def\wdmcoupler@comp{%
  \edef\@sz{\poe@key@couplersize\space}%
  \edef\@sep{\poe@key@couplersep\space 0.5 mul }%
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \ifx\poe@key@align\poe@str@center
      \edef\@sep{0 }%
    \fi
  \fi
  %
  \ifx\poe@key@align\poe@str@top
    \def\@yshift{\@sep neg }%
  \else\ifx\poe@key@align\poe@str@bottom
    \def\@yshift{\@sep\space}%
  \else
    \def\@yshift{0 }%
  \fi\fi
  \ifx\poe@key@couplertype\poe@str@couplertype@elliptic
    \psellipse[dimen=outer](!0 \@yshift)(! \@sz \@sz 0.4 mul)
  \else\ifx\poe@key@couplertype\poe@str@couplertype@rectangular
    \psframe[dimen=outer](!\@sz neg \@yshift \@sz 0.4 mul sub )%
                         (!\@sz \@yshift \@sz 0.4 mul add)
  \else\ifx\poe@key@couplertype\poe@str@couplertype@none
    \ifx\poe@key@align\poe@str@top
      \psline[style=Fiber](\oenode{}{1})(\oenodeout{})
      \psline[style=Fiber](! \pst@optexpdict /N@\oenodeout{} @GetCenter end \tx@UserCoor \poe@key@couplersep\space sub)(\oenode{}{2})
    \else
      \psline[style=Fiber](\oenode{}{2})(\oenodeout{})
      \ifx\poe@key@aling\poe@str@bottom
        \psline[style=Fiber](! \pst@optexpdict /N@\oenodein{} @GetCenter end \tx@UserCoor \poe@key@couplersep\space sub)(\oenode{}{1}) 
      \fi
    \fi
  \fi\fi\fi
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% WDM SPLITTER
%
\def\wdmsplitter@nodes{%
  \edef\@sz{\poe@key@couplersize\space}%
  \edef\@sep{\poe@key@couplersep\space 0.5 mul }%
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \ifx\poe@key@align\poe@str@center
      \edef\@sep{0 }%
    \fi
  \fi
  %
  \ifx\poe@key@align\poe@str@top
    \def\@yshift{\@sep neg }%
  \else\ifx\poe@key@align\poe@str@bottom
    \def\@yshift{\@sep }%
  \else
    \def\@yshift{0 }%
  \fi\fi
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \pnode(! \@sz -0.5 mul 0){\oenode{}{1}}
    \pnode(! \@sz 0.5 mul \@yshift \@sep add){\oenode{}{2}}
    \pnode(! \@sz 0.5 mul \@yshift \@sep sub){\oenode{}{N}}
  \else
    \pnode(! \@sz neg \getCLW 0.3 mul add 0){\oenode{}{1}}
    \pnode(! \@sz \getCLW 0.3 mul sub \@yshift \@sep add){\oenode{}{2}}
    \pnode(! \@sz \getCLW 0.3 mul sub \@yshift \@sep sub){\oenode{}{N}}
  \fi
  \pnode(! 0 \@yshift){\oenodecenter{}}
}%
\def\wdmsplitter@comp{%
  \edef\@sz{\poe@key@couplersize\space}%
  \edef\@sep{\poe@key@couplersep\space 0.5 mul }%
  \ifx\poe@key@couplertype\poe@str@couplertype@none
    \ifx\poe@key@align\poe@str@center
      \edef\@sep{0 }%
    \fi
  \fi
  %
  \ifx\poe@key@align\poe@str@top
    \def\@yshift{\@sep neg }%
  \else\ifx\poe@key@align\poe@str@bottom
    \def\@yshift{\@sep\space}%
  \else
    \def\@yshift{0 }%
  \fi\fi
  \ifx\poe@key@couplertype\poe@str@couplertype@elliptic
    \psellipse[dimen=outer](!0 \@yshift)(! \@sz \@sz 0.4 mul)
  \else\ifx\poe@key@couplertype\poe@str@couplertype@rectangular
    \psframe[dimen=outer](!\@sz neg \@yshift \@sz 0.4 mul sub )%
                         (!\@sz \@yshift \@sz 0.4 mul add)
  \else\ifx\poe@key@couplertype\poe@str@couplertype@none
    \ifx\poe@key@align\poe@str@top
      \psline[style=Fiber](\oenodein{})(\oenode{}{2})
      \psline[style=Fiber](! \pst@optexpdict /N@\oenodein{} @GetCenter end \tx@UserCoor \poe@key@couplersep\space sub)(\oenode{}{N})
    \else
      \psline[style=Fiber](\oenodein{})(\oenode{}{N})
      \ifx\poe@key@align\poe@str@bottom
        \psline[style=Fiber](! \pst@optexpdict /N@\oenodein{} @GetCenter end \tx@UserCoor \poe@key@couplersep\space sub)(\oenode{}{2})
      \fi
    \fi
  \fi\fi\fi
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FIBER COLLIMATOR
%
\def\fibercollimator@nodes{%
   \def\@sz{\poe@key@fibercolsize\space 0.5 mul }%
   \pnode(!\@sz neg 0){\oenodein{}}
   \newOptexpComp{ {\@sz neg 0} {0 1} trans {NewPlaneInt} 1 }%
   \pnode(!\@sz 0){\oenodeout{}}
}%
\def\fibercollimator@comp{%
   \def\@sz{\poe@key@fibercolsize\space 0.5 mul }%
   \pspolygon(! \@sz neg \getCLWH add \@sz neg)(!\@sz 0)(!\@sz neg \getCLWH add \@sz)
}%
%
\catcode`\@=\PstAtCode\relax
%
\endinput
