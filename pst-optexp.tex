%%
%% This is file `pst-optexp.tex',
%%
%% IMPORTANT NOTICE:
%%
%% Package `pst-optexp.tex'
%%
%% Christoph Bersch <usenet _at_ bersch.net>
%%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory CTAN:/macros/latex/base/lppl.txt.
%%
%% DESCRIPTION:
%%   `pst-optexp' is a PSTricks package to draw optical experimental setups
%%
%% HISTORY -> see file Changes
%%
\csname PSToptexpLoaded\endcsname
\let\PSToptexpLoaded\endinput
%
%
\def\fileversion{1.2}
\def\filedate{2008/06/17}
\message{`pst-optexp' v\fileversion, \filedate\space (CB)}
%
\edef\PstAtCode{\the\catcode`\@} \catcode`\@=11\relax
\pst@addfams{optexp}
\pstheader{pst-optexp.pro}
\def\pst@optexpdict{tx@OptexpDict begin }
\SpecialCoor
%
% In some versions of pstricks-add previous to 2.81 the macro
% \nlput is buggy. In these cases it is redefined here.
\ifdim\pstricksaddfileversion pt<2.81pt
\typeout{}
\typeout{pst-optexp: please update pstricks-add to version >= 2.81}
\typeout{}
\def\psLDNode(#1)(#2)#3#4{%
% #1: node A  #2: node B  #3: dimen measured from A  #4: node name
  \pst@getcoor{#1}\pst@tempA%
  \pst@getcoor{#2}\pst@tempB%
  \pssetlength\pst@dimp{#3}%
  \pnode(!%
    \pst@tempA /YA exch \pst@number\psyunit div def
    /XA exch \pst@number\psxunit div def
    \pst@tempB /YB exch \pst@number\psyunit div def
    /XB exch \pst@number\psxunit div def
    /dx XB XA sub def
    /dy YB YA sub def
    /angle dy dx Atan def
    /linelength \pst@number\pst@dimp \pst@number\psunit div def
    XA linelength angle cos mul add YA linelength angle sin mul add ){#4}%
}%
\def\nlput{\pst@object{nlput}}
\def\nlput@i(#1)(#2)#3#4{%
  \begin@SpecialObj
  \psLDNode(#1)(#2){#3}{temp@lnput}
  \pcline[linestyle=none](#1)(temp@lnput)%
  \ncput[npos=1]{#4}%
  \end@SpecialObj
}%
\fi
%
% IF's
%
\newif\ifPst@optexp@variable
\newif\ifPst@optexp@crystal@voltage
\newif\ifPst@optexp@crystal@caxisinv
\newif\ifPst@optexp@reverse
\newif\ifPst@optexp@crystal@lamp
\newif\ifPst@optexp@component@optional
\newif\ifPst@optexp@debug@showoptdots
\newif\ifPst@optexp@endbox
\newif\ifPst@optexp@thicklens
%
% Strings
\def\pst@string@pol@polperp{perp}
\def\pst@string@pol@polparallel{parallel}
\def\pst@string@pol@polmisc{misc}
\def\pst@string@pol@polrcirc{rcirc}
\def\pst@string@pol@pollcirc{lcirc}
\def\pst@string@mirror@type@piezo{piezo}
\def\pst@string@mirror@type@plain{plain}
\def\pst@string@mirror@type@extended{extended}
\def\pst@string@optgrid@type@blazed{blazed}
\def\pst@string@optgrid@type@binary{binary}
%
\def\pst@string@lens@type@plainconvex{plainconvex}
\def\pst@string@lens@type@convexplain{convexplain}
\def\pst@string@lens@type@biconvex{biconvex}
\def\pst@string@lens@type@plainconcave{plainconcave}
\def\pst@string@lens@type@concaveplain{concaveplain}
\def\pst@string@lens@type@biconcave{biconcave}
%
\def\pst@string@labelref@relative{relative}
\def\pst@string@labelref@relgrav{relgrav}
\def\pst@string@labelref@global{global}
%
% psstyles
%
\newpsstyle{OptionalStyle}{linestyle=dashed,dash=1.5pt 1pt}%
\newpsstyle{ExtendedMirror}{linestyle=none,%
                hatchwidth=0.5\psk@optexp@mirror@linewidth,%0.6pt,%
                hatchsep=1.4\psk@optexp@mirror@linewidth,%
                fillstyle=hlines}%
\newpsstyle{PiezoMirror}{fillstyle=solid,fillcolor=black!30}%
\newpsstyle{OptBeam}{linecolor=green!90!black}%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Parameterdefinitions
%
% General
\define@boolkey[psset]{optexp}[Pst@optexp@component@]{optional}[true]{}
\define@key[psset]{optexp}{position}{\edef\psk@optexp@position{#1}}
\define@key[psset]{optexp}{abspos}{\edef\psk@optexp@abspos{#1}}
\define@key[psset]{optexp}{angle}{\edef\psk@optexp@angle{#1}}
%
% Lens
\define@key[psset]{optexp}{lensheight}{\edef\psk@optexp@lens@height{#1}}
\define@key[psset]{optexp}{lenswidth}{\edef\psk@optexp@lens@width{#1}}
\define@key[psset]{optexp}{lensradiusleft}{\edef\psk@optexp@lens@radiusLeft{#1}}
\define@key[psset]{optexp}{lensradiusright}{\edef\psk@optexp@lens@radiusRight{#1}}
\define@boolkey[psset]{optexp}[Pst@optexp@]{thicklens}[true]{}
\define@key[psset]{optexp}{lensradius}{%
   \psset{lensradiusleft=#1,%
      lensradiusright=#1}%
   \edef\psk@optexp@lens@radius{#1}%
}%
% Lens Type (only for backward compatibility)
% 0 -> plainconvex
% 1 -> convexplain
% 2 -> biconvex
% 3 -> plainconcave
% 4 -> concaveplain
% 5 -> biconcave
%
\define@key[psset]{optexp}{lenstype}{%
  \def\pst@tempA{#1}
  \edef\psk@optexp@lens@type{%
    \ifx\pst@string@lens@type@plainconvex\pst@tempA 0\else
    \ifx\pst@string@lens@type@convexplain\pst@tempA 1\else
    \ifx\pst@string@lens@type@biconvex\pst@tempA 2\else
    \ifx\pst@string@lens@type@plainconcave\pst@tempA 3\else
    \ifx\pst@string@lens@type@concaveplain\pst@tempA 4\else
    \ifx\pst@string@lens@type@biconcave\pst@tempA 5%
    \fi\fi\fi\fi\fi\fi%
}}
\define@key[psset]{optexp}{lens}{%
  \pst@expandafter\psset@@lens{#1} {} {} {} {} {}\@nil
}%
\def\psset@@lens#1 #2 #3 #4 #5\@nil{%
  \edef\pst@temp{#4}%
  \ifx\pst@temp\@empty\else
     \psset{lenswidth=#4}%
  \fi
  \edef\pst@temp{#3}%
  \ifx\pst@temp\@empty\else
     \psset{lensheight=#3}
  \fi
  \edef\pst@temp{#2}%
  \ifx\pst@temp\@empty
     \psset{lensradiusright=#1}%
  \else
     \psset{lensradiusright=#2}%
  \fi
  \psset{lensradiusleft=#1}%
}%
%
% Pinhole
\define@key[psset]{optexp}{innerheight}{\edef\psk@optexp@pinhole@iheight{#1}}
\define@key[psset]{optexp}{iwidth}{%
   \edef\psk@optexp@pinhole@iheight{#1}%
   \PackageWarning{pst-optexp}{iwidth is obsolete, use innerheight instead}
}
\define@key[psset]{optexp}{outerheight}{\edef\psk@optexp@pinhole@oheight{#1}}
\define@key[psset]{optexp}{owidth}{%
   \edef\psk@optexp@pinhole@oheight{#1}%
   \PackageWarning{pst-optexp}{owidth is obsolete, use outerheight instead}
}
\define@key[psset]{optexp}{phlinewidth}{\edef\psk@optexp@pinhole@linewidth{#1}}
%
% Beamsplitter
\define@key[psset]{optexp}{bssize}{\edef\psk@optexp@bssize{#1}}
\define@key[psset]{optexp}{bswidth}{%
   \edef\psk@optexp@bssize{#1}%
   \PackageWarning{pst-optexp}{bswidth is obsolete, use bssize instead}%
}
%
% Crystal
\define@key[psset]{optexp}{crystalwidth}{\edef\psk@optexp@crystal@width{#1}}
\define@key[psset]{optexp}{crystalheight}{\edef\psk@optexp@crystal@height{#1}}
\define@key[psset]{optexp}{caxislength}{\edef\psk@optexp@crystal@caxislength{#1}}
\define@boolkey[psset]{optexp}[Pst@optexp@crystal@]{voltage}[true]{}
\define@boolkey[psset]{optexp}[Pst@optexp@crystal@]{caxisinv}[true]{}
\define@boolkey[psset]{optexp}[Pst@optexp@crystal@]{lamp}[true]{}
\define@key[psset]{optexp}{lampscale}{\def\psk@optexp@lamp@scale{#1}}
%
% Mirror
\define@key[psset]{optexp}{mirrorwidth}{\edef\psk@optexp@mirror@width{#1}}
\define@key[psset]{optexp}{mirrorlinewidth}{\edef\psk@optexp@mirror@linewidth{#1}}
\define@key[psset]{optexp}{mirrortype}{\edef\psk@optexp@mirror@type{#1}}% piezo, extended, plain
\define@key[psset]{optexp}{mirrordepth}{\edef\psk@optexp@mirror@depth{#1}}
\define@key[psset]{optexp}{mirrorradius}{\edef\psk@optexp@mirror@radius{#1}}
\define@boolkey[psset]{optexp}[Pst@optexp@]{variable}[true]{}
%
% Grid
\define@key[psset]{optexp}{optgridcount}{\edef\psk@optexp@optgrid@count{#1}}
\define@key[psset]{optexp}{optgridwidth}{\edef\psk@optexp@optgrid@width{#1}}
\define@key[psset]{optexp}{optgridheight}{\edef\psk@optexp@optgrid@height{#1}}
\define@key[psset]{optexp}{optgridtype}{\edef\psk@optexp@optgrid@type{#1}}
\define@key[psset]{optexp}{optgriddepth}{\edef\psk@optexp@optgrid@depth{#1}}
\define@key[psset]{optexp}{optgridlinewidth}{\edef\psk@optexp@optgrid@linewidth{#1}}
\define@boolkey[psset]{optexp}[Pst@optexp@]{reverse}[true]{}
%
% Box
\define@key[psset]{optexp}{optboxwidth}{\edef\psk@optexp@optbox@width{#1}}
\define@key[psset]{optexp}{optboxheight}{\edef\psk@optexp@optbox@height{#1}}
\define@boolkey[psset]{optexp}[Pst@optexp@]{endbox}[true]{}
%
% Plate
\define@key[psset]{optexp}{platelinewidth}{\edef\psk@optexp@plate@linewidth{#1}}
\define@key[psset]{optexp}{plateheight}{\edef\psk@optexp@plate@height{#1}}
%
% Optical Retardation Plate
\define@key[psset]{optexp}{platewidth}{\edef\psk@optexp@plate@width{#1}}
%
% Detector
\define@key[psset]{optexp}{detsize}{\edef\psk@optexp@detector@size{#1}}
%
% Polarization
\define@key[psset]{optexp}{polwidth}{%
   \edef\psk@optexp@polarization@size{#1}%
   \PackageWarning{pst-optexp}{polwidth is obsolete, use polsize instead}%
}
\define@key[psset]{optexp}{polsize}{\edef\psk@optexp@polarization@size{#1}}
\define@key[psset]{optexp}{pollinewidth}{\edef\psk@optexp@polarization@linewidth{#1}}
\define@key[psset]{optexp}{poltype}{\edef\psk@optexp@pol@type{#1}}
\define@key[psset]{optexp}{pol}{%
   \edef\psk@optexp@poltype{#1}%
   \PackageWarning{pst-optexp}{pol is obsolete, use poltype instead}%
}
%
% Label
\define@key[psset]{optexp}{labelangle}{\edef\psk@optexp@label@angle{#1}}
\define@key[psset]{optexp}{labeloffset}{\edef\psk@optexp@label@offset{#1}}
\define@key[psset]{optexp}{labelstyle}{\def\psk@optexp@label@style{#1}}
\define@key[psset]{optexp}{labelalign}{\def\psk@optexp@label@align{#1}}
\define@key[psset]{optexp}{labelref}{\edef\psk@optexp@label@ref{#1}}
% for internal use only
\define@key[psset]{optexp}{ref@angle}{\edef\psk@optexp@label@refangle{#1}}
% labelrelative is obsolete
\define@choicekey*[psset]{optexp}{labelrelative}[\val\nr]{true,false}[true]{%
  \ifcase\nr\relax
     \psset{labelref=relative}
  \or
     \psset{labelref=global}
  \fi
  \PackageWarning{pst-optexp}{labelrelative is obsolete, please use labelref=relative instead}
}
%
% Debug
\define@boolkey[psset]{optexp}[Pst@optexp@debug@]{showoptdots}[true]{}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% BASIC MACROS
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Command analog to addbefore@par which is defined in pstricks.tex
% addafter@par inserts new options at the _end_ of the current token register.
% This can be useful to preset options that are not allowed to be changed by the
% user.
%
\def\addafter@par#1{%
  \ifx\pst@par\@empty
    \def\pst@par{#1}%
  \else
    \toks@{#1}%
    \pst@toks\expandafter{\pst@par}%
    \edef\pst@par{\the\pst@toks,\the\toks@}%
  \fi%
}
%
% New high-level macros 
% 1) Allow a compressed notation of all provided elements, as most of the organizing code 
%    is mostly equal.
%
% 2) Provide a rather easy-to-use interface for the user to allow new user-defined elements
%
\def\newOptexpDipole{\@ifnextchar[{\new@optexpdipole}{\new@optexpdipole[]}}
\def\newOptexpDipoleNolabel{\@ifnextchar[{\new@optexpdipolenolabel}{\new@optexpdipolenolabel[]}}
\def\newOptexpTripole{\@ifnextchar[{\new@optexptripole}{\new@optexptripole[]}}
%
% Creates new macros ...@i and ...@ii which provide most code for the arrangement
% of the objects. A tempNode@Label is predefined as well as two internal nodes if compname is
% defined.
% ...@iii must be defined manually and should contain all the stroking code
\def\new@optexpdipole[#1]#2#3{%
   \@ifundefined{#2@i}{%
      \@namedef{#2}{\pst@object{#2}}%
      \expandafter\def\csname #2@i\endcsname(##1)(##2)##3{%
         \pst@killglue
         \addbefore@par{#3}%
         \addafter@par{#1}%
         \begingroup
            \use@par
            \pst@regNodes{##1}{##2}
            \pst@draw@component{##3}{\@nameuse{#2@ii}}
         \endgroup
      }%
      \@namedef{#2@ii}{%
        \pnode(0,0){tempNode@Label}%
        \@nameuse{#2@iii}%
      }%
   }{%
     \@pstrickserr{OptExp dipole object `#2' already defined}\@eha}%
\ignorespaces}%
%
% Equivalent to new@optexdipole, only that objects without labels are created.
\def\new@optexpdipolenolabel[#1]#2#3{%
   \@ifundefined{#2@i}{%
      \@namedef{#2}{\pst@object{#2}}%
      \expandafter\def\csname #2@i\endcsname(##1)(##2){%
         \pst@killglue
         \addbefore@par{#3}%
         \addafter@par{#1}%
         \begingroup
            \use@par
            \pst@regNodes{##1}{##2}
            \pst@draw@component{}{\@nameuse{#2@ii}}
         \endgroup
      }%
      \@namedef{#2@ii}{%
        \pnode(0,0){tempNode@Label}%
        \@nameuse{#2@iii}%
      }%
   }{%
     \@pstrickserr{OptExp dipole object `#2' already defined}\@eha}%
\ignorespaces}%
%
% Equivalent to new@optexpdipole for tripole objects.
\def\new@optexptripole[#1]#2#3{%
   \@ifundefined{#2@i}{%
      \@namedef{#2}{\pst@object{#2}}%
      \expandafter\def\csname #2@i\endcsname(##1)(##2)(##3)##4{%
         \pst@killglue
         \addbefore@par{#3}%
         \addafter@par{ref@angle=180,#1}%
         \begingroup
            \use@par
            \pst@calcNodes{##1}{##2}{##3}
            \pst@draw@component{##4}{\@nameuse{#2@ii}}
         \endgroup
      }%
      \@namedef{#2@ii}{%
        \pnode(0,0){tempNode@Label}%
        \@nameuse{#2@iii}%
      }%
   }{%
     \@pstrickserr{OptExp tripole object `#2' already defined}\@eha}%
\ignorespaces}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Some of the components need three points to be positioned. 
%   These are:
%
%       1. starting point of the beam (in the PS-Code: (XA,YA))
%       2. reflection point on the surface (XG, YG)
%       3. end point (XB,YB)
%
%  With these three points \pst@calcNodes calculates two new points 'tempNode@A' 
%  and 'tempNode@B', between which the component is placed by the macro 
%  \pst@draw@component in the way, that 'angle of incidence' == 'angle of deflection'
%  regarding the reflection surface (mirror, diagonal of the beamsplitter, 
%  grid etc.)
% 
\def\pst@calcNodes#1#2#3{{%
  \pst@getcoor{#1}\pst@tempa%
  \pst@getcoor{#2}\pst@tempb%
  \pst@getcoor{#3}\pst@tempc%
  \pnode(!%
     \pst@optexpdict
     \pst@tempa \pst@number\psyunit div exch \pst@number\psxunit div exch 
     \pst@tempc \pst@number\psyunit div exch \pst@number\psxunit div exch 
     \pst@tempb \pst@number\psyunit div exch \pst@number\psxunit div exch 
     calcNodes
     X@A Y@A end){tempNode@A}%
  \pnode(! \pst@optexpdict X@B Y@B end){tempNode@B}%
}\ignorespaces}%
%
%
% If a macro needs only two points, they are equivalent to 
% 'tempNode@A' and 'tempNode@B'. But for easier implementation of other 
% macros the given points are assigned to the temporary nodes.
%
\def\pst@regNodes#1#2{%
    \pnode(#1){tempNode@A}
    \pnode(#2){tempNode@B}
\ignorespaces}%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Some other usefuls macros
%
% Define a new node #3 shifted by (#1) relative to existing node #2.
% Aditionally rotate the new node by #4 degree around existing node as origin.
%
\def\pst@defShiftedRotLabelNode(#1)#2#3#4{%
    \pst@getcoor{#1}\pst@tempDiff%
    \pnode(!%
       \pst@tempDiff /YDiff ED /XDiff ED %
         /N@#2 load GetCenter /YShifted ED /XShifted ED
         /rot@angle #4 \psk@optexp@label@refangle\space add def
         /XDiff@Rot rot@angle cos XDiff mul rot@angle sin YDiff mul add def
         /YDiff@Rot rot@angle cos YDiff mul rot@angle sin XDiff mul sub def
         XShifted XDiff@Rot add \pst@number\psxunit div
         YShifted YDiff@Rot add \pst@number\psyunit div neg
       ){#3}%
    % reset reference label to 0
    \psset{ref@angle=0}
}%
%
% Define a new node #3 that is shifted by (#1) 
% with respect to the existing node #2
\def\pst@defShiftedLabelNode(#1)#2#3{%
  \pst@defShiftedRotLabelNode(#1){#2}{#3}{0}%
}%
%
% Used to put the label for labelref=relative
%
\def\put@RelLabel#1{%
   \nput[labelsep=0]{\psk@optexp@label@angle}%
        {tempNode@LabelShifted}%
        {\rput[\psk@optexp@label@align](0,0){\psk@optexp@label@style #1}}%
}%
%
% Place the component in argument #1 and define a new node 'tempNode@LabelShifted'
% for positioning of the label
\def\put@Comp#1{%
   #1%
   \pst@defShiftedRotLabelNode(0,\psk@optexp@label@offset)%
                         {tempNode@Label}%
                         {tempNode@LabelShifted}%
                         {\psk@optexp@label@angle}%
}%
%
% Positioning of the label depending on the reference coordinates.
% Needs possibly a previously defined node tempNode@LabelShifted which
% marks exactly the position of the label relative to the component.
% This is defined by calling \put@Comp.
% 
% Parameter 'labelref' which sets the reference coordinates can have 
% the values 
%   global   => labelangle rotates the label origin in global coordinate 
%               system, text is not rotated
%   relgrav  => labelangle rotates the label origin relativ to the local
%               coordinate system of the component, text is not rotated
%   relative => as relgrav but text is rotated together with object.
%
\def\put@Label#1{%
   \ifx\psk@optexp@label@ref\pst@string@labelref@global
      %
      % global
      \nput[labelsep=\psk@optexp@label@offset]%
           {\psk@optexp@label@angle}%
           {tempNode@Label}%
           {\rput[\psk@optexp@label@align](0,0){\psk@optexp@label@style #1}}%
      %
   \else\ifx\psk@optexp@label@ref\pst@string@labelref@relgrav
      %
      % relgrav
      \rput[\psk@optexp@label@align](tempNode@LabelShifted){\psk@optexp@label@style #1}%
      %
   \else\ifx\psk@optexp@label@ref\pst@string@labelref@relative
      %
      % relative
      \begingroup
      %
      % Redefine InitNC only for positioning of the label with 
      % labelref=relative
      %
      \pst@def{InitNC}<       % kindly contributed by Herbert Voss
      /b ED /a ED % second and first node
      /NodeSepTypeB ED /NodeSepTypeA ED
      /NodeSepB ED /NodeSepA ED
      /OffsetB ED /OffsetA ED
      tx@NodeDict a known tx@NodeDict b known and dup {
        /NodeA a load def /NodeB b load def
        NodeA GetCenter NodeB GetCenter % xA yA xB yB
        4 copy pop exch pop le % xA xB
          { /yB ED /xB ED /yA ED /xA ED }
          { /yA ED /xA ED /yB ED /xB ED } ifelse
      } if >%
      % 
      \ncline[linestyle=none,fillstyle=none,npos=]{tempNode@A}{tempNode@B}%
      % 
      % 
      \ifx\psk@optexp@position\@empty
         \ifx\psk@optexp@abspos\@empty
            \ncput[nrot=:U,npos=]{\put@RelLabel{#1}}
         \else
            \nlput[nrot=:U](tempNode@A)(tempNode@B){\psk@optexp@abspos}{\put@RelLabel{#1}}
         \fi
      \else
         \ncput[nrot=:U,npos=\psk@optexp@position]{\put@RelLabel{#1}}
      \fi
      %
      \endgroup
   \fi\fi\fi
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FREE-RAY COMPONENTS
%
% DIPOLES
%
\newOptexpDipole{lens}{}%
\newOptexpDipole{pinhole}{}%
\newOptexpDipole{crystal}{}%
\newOptexpDipoleNolabel{polarization}{}%
\newOptexpDipole{optbox}{}%
\newOptexpDipole{optplate}{}%
\newOptexpDipole{optretplate}{}%
\newOptexpDipole[endbox]{detector}{}%
\newOptexpDipole{optdipole}{}%
%
% TRIPOLES
%
\newOptexpTripole{mirror}{}%
\newOptexpTripole[ref@angle=-135]{beamsplitter}{}%
\newOptexpTripole{optgrid}{}%
%
% SPECIAL OBJECTS
%
\def\optdipole{\pst@object{optdipole}}
\def\optdipole@i(#1)(#2)#3#4{%
   \pst@killglue
   \begingroup
      \use@par
      \pst@regNodes{#1}{#2}
      \pst@draw@component{#4}{%
         \pnode(0,0){tempNode@Label}% 
         #3
      }%
   \endgroup
}%
\def\opttripole{\pst@object{opttripole}}
\def\opttripole@i(#1)(#2)(#3)#4#5{%
   \pst@killglue
   \begingroup
      \use@par
      \pst@calcNodes{#1}{#2}{#3}
      \pst@draw@component{#5}{%
         \pnode(0,0){tempNode@Label}% 
         #4
      }%
   \endgroup
}%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% default settings
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\psset{%
% general
        position=\@empty
        ,abspos=\@empty
        ,angle=0
% lens
        ,lenswidth=0.2
        ,lensheight=1
        ,lenstype=\@empty
        ,lensradius=\@empty
        ,lensradiusleft=1
        ,lensradiusright=1
% pinhole
        ,phlinewidth=2\pslinewidth
        ,outerheight=1
        ,innerheight=0.1
% beamsplitter
        ,bssize=0.8
% crystal
        ,crystalwidth=2
        ,crystalheight=0.8
        ,caxislength=0.6
        ,lampscale=0.3
% mirror
        ,mirrorwidth=1
        ,mirrordepth=0.08
        ,mirrorradius=0
        ,mirrortype=\pst@string@mirror@type@plain
        ,mirrorlinewidth=2\pslinewidth
% optgrid
        ,optgridcount=10
        ,optgridwidth=1
        ,optgridheight=0.1
        ,optgriddepth=0.05
        ,optgridtype=\pst@string@optgrid@type@blazed
        ,optgridlinewidth=0.7\pslinewidth
% optbox
        ,optboxwidth=1
        ,optboxheight=0.5
% optplate
        ,plateheight=1
        ,platelinewidth=2\pslinewidth
% optretplate
        ,platewidth=0.1
% detector
        ,detsize=0.5
% polarization
        ,poltype=\pst@string@pol@polparallel
        ,polsize=0.6
        ,pollinewidth=0.7\pslinewidth
% label
        ,labeloffset=0.8
        ,labelangle=0
        ,labelstyle=\small
        ,labelalign=c
        ,labelref=relgrav
        ,ref@angle=0
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% DRAW COMPONENTS
%
% This macro is called by every unit
%
\def\pst@draw@component#1#2{%
    % 
    \ifPst@optexp@endbox%
       \ifx\psk@optexp@label@offset\@empty
          \psset{labeloffset=0}
       \fi
       \psset{position=1}%
    \fi%
    % 
    % linestyle to use, if component should be marked as optional
    \ifPst@optexp@component@optional
      \psset{style=OptionalStyle}
    \fi
    \ncline[linestyle=none,fillstyle=none,npos=]{tempNode@A}{tempNode@B}%
    % 
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
    % 
    % Positioning of the component
    % 
    % if parameter 'position' is given, use it for 'npos'
    \ifx\psk@optexp@position\@empty
    % 
    % then check if absolute positioning is wanted
        \ifx\psk@optexp@abspos\@empty
           \ncput[nrot=:U,npos=]{\put@Comp{#2}}
        \else
           \nlput[nrot=:U](tempNode@A)(tempNode@B){\psk@optexp@abspos}{\put@Comp{#2}}
        \fi
    \else
       \ncput[nrot=:U,npos=\psk@optexp@position]{\put@Comp{#2}}
    \fi
    %
    % Now put the label
    \put@Label{#1}%
    %
    % Show some special dots for debugging
    \ifPst@optexp@debug@showoptdots
        \psdot[linecolor=red](tempNode@Label)
        \psdot[linecolor=red](tempNode@LabelShifted)
        \psdot[linecolor=black](tempNode@A)
        \psdot[linecolor=black](tempNode@B)
    \fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% IMPLEMENTATIONS OF ALL ...@iii MACROS
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% MIRROR
%
\def\mirror@iii{%
   \edef\@mirror@ht{\psk@optexp@mirror@width\space\pst@number\psyunit mul 2 div }%
   \edef\@mirror@dp{\psk@optexp@mirror@depth\space\pst@number\psxunit mul }%
   \edef\@mirror@r{\psk@optexp@mirror@radius\space\pst@number\psxunit mul }%
   \edef\@mirror@postcode{neg 5 -1 roll exch 5 2 roll 90 add exch 90 add exch ArcR }%
   \edef\@mirror@extpostcode{neg \@mirror@dp add 5 -1 roll exch 5 2 roll 90 add exch 90 add }%
   %
   %
   % concave mirrors
   %
   \ifdim\psk@optexp@mirror@radius pt<0pt
      % always draw the input plane
      \begin@OpenObj
      \addto@pscode{\pst@optexpdict \@mirror@ht \@mirror@r rightConcave \@mirror@postcode end}%
      \end@OpenObj
      \ifx\psk@optexp@mirror@type\pst@string@mirror@type@extended
         % 
         % extended concave mirror
         \psset{style=ExtendedMirror}
         \begin@ClosedObj
         \addto@pscode{\pst@optexpdict \@mirror@ht \@mirror@r rightConcave \@mirror@postcode  
            \@mirror@ht \@mirror@r rightConcave \@mirror@extpostcode arc
            closepath end}%
         \end@ClosedObj
      \fi
   %
   %
   % convex mirrors
   %
   \else\ifdim\psk@optexp@mirror@radius pt>0pt
      % always draw the input plane
      \begin@OpenObj
      \addto@pscode{\pst@optexpdict \@mirror@ht \@mirror@r rightConvex \@mirror@postcode end}%
      \end@OpenObj
      \ifx\psk@optexp@mirror@type\pst@string@mirror@type@extended
         % 
         % extended convex mirror
         \psset{style=ExtendedMirror}
         \begin@ClosedObj
         \addto@pscode{\pst@optexpdict \@mirror@ht \@mirror@r rightConvex \@mirror@postcode
            \@mirror@ht \@mirror@r rightConvex \@mirror@extpostcode arcn
            closepath end}%
         \end@ClosedObj
      \fi
   \else
      % 
      % plain mirror 
      %
      \edef\@m@wd{\psk@optexp@mirror@width\space 2 div }
      \ifPst@optexp@variable
         \psarc[linewidth=0.8\pslinewidth,arrowinset=0,arrowscale=0.8]{<->}
            (! \@m@wd 0.4 sub 0){0.6}{-20}{20}
         \psarc[linewidth=0.8\pslinewidth,arrowinset=0,arrowscale=0.8]{<->}
            (! \@m@wd 0.4 sub neg 0){0.6}{160}{200}
     \fi
     \psline[linewidth=\psk@optexp@mirror@linewidth](! \@m@wd neg 0)(! \@m@wd 0)
     % 
     % mirrortype
     \ifx\psk@optexp@mirror@type\pst@string@mirror@type@piezo%
        % 
        % piezo
        \psframe[style=PiezoMirror](! \@m@wd 4 div 0)(! \@m@wd -4 div \@m@wd 2.5 div)
        \psbezier(! 0 \@m@wd 2.5 div)%
                 (! 0 \@m@wd 1.5 div)%
                 (! \@m@wd 2 div \@m@wd 2 div)%
                 (! \@m@wd 4 div \@m@wd)%
     \else\ifx\psk@optexp@mirror@type\pst@string@mirror@type@extended%
        % 
        % extended
        \psframe[style=ExtendedMirror]%
           (! \@m@wd neg \psk@optexp@mirror@depth\space )%
           (! \@m@wd 0)%
     \fi\fi
  \fi\fi
}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% LENS
%
\def\lens@iii{%
   %
   % use old lens code to maintain backward compatibility
   \ifx\psk@optexp@lens@type\@empty
   % NEW CODE!
   \begin@ClosedObj
   \edef\@lens@wd{\psk@optexp@lens@width\space\pst@number\psxunit mul 2 div }%
   \edef\@lens@ht{\psk@optexp@lens@height\space\pst@number\psyunit mul 2 div }%
   \edef\@lens@rL{\psk@optexp@lens@radiusLeft\space\pst@number\psxunit mul }%
   \edef\@lens@rR{\psk@optexp@lens@radiusRight\space\pst@number\psxunit mul }%	
   \edef\@lens@th{}%
   \addto@pscode{\pst@optexpdict}%
   % 
   % distinguish between all the different lens-combination possibilities
   % 
    \ifdim\psk@optexp@lens@radiusLeft pt=0pt\else
       \edef\@lens@th{\ifPst@optexp@thicklens \@lens@wd\else a1 \fi}%
       \addto@pscode{%
         \@lens@ht \@lens@rL
         \ifdim\psk@optexp@lens@radiusLeft pt<0pt
            leftConcave
         \else
            leftConvex
         \fi
       }%
    \fi
    \ifdim\psk@optexp@lens@radiusRight pt=0pt\else
       \edef\@lens@th{\@lens@th\space\ifPst@optexp@thicklens \@lens@wd\else a2 \fi}%
       \addto@pscode{%
         \@lens@ht \@lens@rR
         \ifdim\psk@optexp@lens@radiusRight pt<0pt
            rightConcave
         \else
            rightConvex
         \fi
       }%
    \fi
    % 
    % check some special cases
    % 
    % 1) Left is plain  -  right concave
    % \- right convex
    \ifdim\psk@optexp@lens@radiusLeft pt=0pt
       \ifdim\psk@optexp@lens@radiusRight pt=0pt\else
          \addto@pscode{\@lens@th 2 div sub neg 5 1 roll }%
          \ifdim\psk@optexp@lens@radiusRight pt<0pt
             \addto@pscode{%
               \@lens@th 2 div neg \@lens@ht neg moveto ArcR
               \@lens@th 2 div neg \@lens@ht lineto}%
          \else
             \addto@pscode{ArcR}%
          \fi
       \fi
    \fi
    % 
    % 
    % 2) Right is plain -  left concave
    % \- left convex
    \ifdim\psk@optexp@lens@radiusRight pt=0pt
       \ifdim\psk@optexp@lens@radiusLeft pt=0pt\else
          \addto@pscode{\@lens@th 2 div sub 5 1 roll }%
          \ifdim\psk@optexp@lens@radiusLeft pt<0pt
             \addto@pscode{\@lens@th 2 div \@lens@ht moveto ArcL
               \@lens@th 2 div \@lens@ht neg lineto }%
          \else
             \addto@pscode{ArcL }%
          \fi
       \fi
    \fi
    % 
    % 3) right and left are both curved
    \ifdim\psk@optexp@lens@radiusRight pt=0pt\else
       \ifdim\psk@optexp@lens@radiusLeft pt=0pt\else
          \addto@pscode{%
            \@lens@th\space add 2 div dup
            7 1 roll sub neg 5 1 roll
            ArcR sub 5 1 roll ArcL }%
       \fi
    \fi
    % 
    % now complete the object
    \addto@pscode{closepath 1 setlinejoin end }%
    \end@ClosedObj
    %
    % OLD CODE (compatibility)
    \else
       \pst@draw@lens
   \fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% LENS (old) maintained for backward compatibility
% used only if lensheight and lenswidth must be used to draw the lens 
% (i.e. when lensradius is not defined)
%
\def\pst@draw@lens{%
%
  \edef\@l@h{\psk@optexp@lens@height\space 2 div\space}%
  \edef\@l@a{\psk@optexp@lens@width\space 2 div\space}%
  % 
  \ifnum\psk@optexp@lens@type<3
  % CONVEX
     \ifx\psk@optexp@lens@radius\@empty
        \edef\@l@r{\@l@a 2 div \@l@h dup mul 2 \@l@a mul div add\space}%
     \else
        \edef\@l@r{\psk@optexp@lens@radius\space}%
        \edef\@l@a{\@l@r dup dup mul \@l@h dup mul sub sqrt sub\space}%
     \fi
     % 
     % define some parameters only for convex lenses
     \edef\@l@d{\@l@r \@l@a sub\space}%
     \edef\@l@alpha{\@l@h \@l@d atan\space}%
     \edef\@l@y{\@l@d\space}%
  \else
     % CONCAVE
     \ifx\psk@optexp@lens@radius\@empty
        \edef\@l@r{\@l@h 1.5 mul\space}%
     \else
        \edef\@l@r{\psk@optexp@lens@radius\space}%
     \fi%
     %
     % define some parameters only for concave lenses
     \edef\@l@d{\@l@r dup mul \@l@h dup mul sub sqrt\space}%
     \edef\@l@alpha{\@l@h \@l@d atan\space}%
     \edef\@l@y{\@l@r \@l@a add\space}%
  \fi%
  % 
  %
  \def\temp@LeftPlot{%
     \parametricplot[liftpen=1]{-1}{1}{%   
        \@l@r \@l@alpha t mul 180 add cos mul \@l@y add \@l@r \@l@alpha t mul 180 add sin mul}%
  }%
  \def\temp@RightPlot{%
     \parametricplot[liftpen=1]{-1}{1}{%  
        \@l@r \@l@alpha t mul cos mul \@l@y sub \@l@r \@l@alpha t mul sin mul}%
  }%      
  %
  %
  \pscustom{%
  \ifcase\psk@optexp@lens@type
     % plainconvex
     \temp@RightPlot%
     \closepath%
  \or
     % convexplain
     \temp@LeftPlot%
     \closepath%
  \or
     % biconvex
    \temp@LeftPlot%
     \temp@RightPlot%
     \closepath
  \or
     % plainconcave
     \temp@LeftPlot%
     \psline[liftpen=1](! 0 \@l@h neg)%
                       (! 0 \@l@h)%
                       (! \@l@r \@l@d sub \@l@a add \@l@h)%
     \closepath
  \or%
     % concaveplain
     \temp@RightPlot%
     \psline[liftpen=1](! 0 \@l@h)%
                       (! 0 \@l@h neg)%
                       (! \@l@r \@l@d sub \@l@a add neg \@l@h neg)%
     \closepath
  \or
     % biconcave
     \temp@RightPlot%
     \temp@LeftPlot%
     \closepath
  \fi
  }%
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% PINHOLE
%
\def\pinhole@iii{%
  \psline[linewidth=\psk@optexp@pinhole@linewidth]%
         (! 0 \psk@optexp@pinhole@oheight\space 2 div)%
         (! 0 \psk@optexp@pinhole@iheight\space 2 div)%
  \psline[linewidth=\psk@optexp@pinhole@linewidth]%
         (! 0 \psk@optexp@pinhole@oheight\space -2 div)%
         (! 0 \psk@optexp@pinhole@iheight\space -2 div)%
\ignorespaces}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% BEAMSPLITTER
%
\def\beamsplitter@iii{%
   \edef\@bs@wd{\psk@optexp@bssize\space 2.0 div\space}%
   \psline{cc-cc}(! \@bs@wd neg 2 sqrt mul 0)(! \@bs@wd 2 sqrt mul 0)
   \rput[c]{45}(0,0){\psframe(! \@bs@wd neg \@bs@wd neg)(! \@bs@wd \@bs@wd)}
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% CRYSTAL
%
\def\crystal@iii{%
   \edef\@c@wd{\psk@optexp@crystal@width\space 2 div\space}%
   \edef\@c@ht{\psk@optexp@crystal@height\space 2 div\space}%
   \rput[c]{\psk@optexp@angle}(0,0){%
      \psframe(! \@c@wd neg \@c@ht neg)(! \@c@wd \@c@ht)
      \ifPst@optexp@crystal@voltage%
         \psline(! \@c@wd 4 div 3 mul neg \@c@ht)%
                (! \@c@wd 4 div 3 mul neg \@c@ht 0.2 add)
         \pscircle[fillstyle=solid,%
                   fillcolor=white](! \@c@wd 4 div 3 mul neg \@c@ht 0.2 add){0.04}
         \psline(! \@c@wd 4 div 3 mul neg \@c@ht neg)%
                (! \@c@wd 4 div 3 mul neg \@c@ht neg 0.2 sub)%
         \psline(! \@c@wd 4 div 3 mul neg 0.15 sub \@c@ht neg 0.2 sub)%
                (! \@c@wd 4 div 3 mul neg 0.15 add \@c@ht neg 0.2 sub)%
      \fi
      % 
      \ifPst@optexp@crystal@lamp
         \rput{180}(! \@c@wd \@c@ht 1.4 \psk@optexp@lamp@scale\space mul add){\lamp}%
      \fi
      % plot c-axis only, if caxislength > 0
      \ifdim\psk@optexp@crystal@caxislength pt>0pt
         \edef\@c@caxisL{\psk@optexp@crystal@caxislength\space 2 div\space}%
         \ifPst@optexp@crystal@caxisinv
            %
            % invert the c-axis
            \psline[linestyle=dashed,%
                    dash=2pt 2pt,%
                    linewidth=0.7\pslinewidth,%
                    arrowinset=0]{->}%
                   (! 0 \@c@ht neg)(! 0 \@c@ht \@c@caxisL add)%
         \else
            \psline[linestyle=dashed,%
                    dash=2pt 2pt,%
                    linewidth=0.7\pslinewidth,%
                    arrowinset=0]{->}%
               (! 0 \@c@ht)(! 0 \@c@ht neg \@c@caxisL sub)%
         \fi
      \fi
   }%
\ignorespaces}%
%
% LAMP FOR THE CRYSTAL
%
\def\lamp{%
  \psset{linewidth=0.6\pslinewidth}
  \edef\@l@s{\psk@optexp@lamp@scale\space}%
  % 
  \pscurve[fillstyle=none](! -0.05 \@l@s mul 0)%
          (! -0.1 \@l@s mul 0.15 \@l@s mul)%
          (! -0.2 \@l@s mul 0.25 \@l@s mul)%
          (! -0.25 \@l@s mul 0.5 \@l@s mul)%
          (! 0 0.7 \@l@s mul)%
          (! 0.25 \@l@s mul 0.5 \@l@s mul)%
          (! 0.2 \@l@s mul 0.25 \@l@s mul)%
          (! 0.1 \@l@s mul 0.15 \@l@s mul)%
          (! 0.05 \@l@s mul 0)
  \multido{\i=-210+40}{7}{%
    \rput{\i}(! 0 0.45 \@l@s mul){\psline(! -0.35 \@l@s mul 0)(! -0.6 \@l@s mul 0)}
  }
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% POLARIZATION
%
\def\polarization@iii{%
%
  \edef\@pol@size{\psk@optexp@polarization@size\space 2 div\space}%
  \ifx\psk@optexp@pol@type\pst@string@pol@polparallel
     \psline[linestyle=solid,linewidth=\psk@optexp@polarization@linewidth,arrowscale=0.8]{<->}%
        (! 0 \@pol@size neg)(! 0 \@pol@size)%
  \fi
  \ifx\psk@optexp@pol@type\pst@string@pol@polperp
     \psdot[dotsize=0.05](0,0)%
     \pscircle[fillstyle=none,linestyle=solid,linewidth=\psk@optexp@polarization@linewidth](0,0){0.12}%
  \fi
  \ifx\psk@optexp@pol@type\pst@string@pol@polmisc
     \psline[linestyle=solid,linewidth=\psk@optexp@polarization@linewidth,arrowscale=0.8]{<->}%
        (! 0 \@pol@size neg)(! 0 \@pol@size)%
     \psdot[dotsize=0.05](0,0)%
     \pscircle[fillstyle=none,linestyle=solid,linewidth=0.7\pslinewidth](0,0){0.12}%
  \fi
  \ifx\psk@optexp@pol@type\pst@string@pol@polrcirc
     \psellipticarc[linewidth=\psk@optexp@polarization@linewidth]{->}%
        (0,0)(! \@pol@size 2 div \@pol@size){20}{-20}%
  \fi
  \ifx\psk@optexp@pol@type\pst@string@pol@pollcirc
     \psellipticarc[linewidth=\psk@optexp@polarization@linewidth]{<-}%
        (0,0)(! \@pol@size 2 div \@pol@size){20}{-20}
  \fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTICAL GRID
%
\def\optgrid@iii{%
   \edef\@g@cnt{\psk@optexp@optgrid@count\space}%
   \edef\@g@wd{\psk@optexp@optgrid@width\space 2 div\space}%
   \edef\@g@ht{\psk@optexp@optgrid@height\space}%
   \edef\@g@dp{\psk@optexp@optgrid@depth\space}%
   \edef\@g@step{\psk@optexp@optgrid@width\space\@g@cnt div\space}%
   \ifx\psk@optexp@optgrid@type\pst@string@optgrid@type@blazed
      \ifPst@optexp@reverse%
         \pscustom[linewidth=\psk@optexp@optgrid@linewidth]{%
            \psline[liftpen=1](! \@g@wd \@g@dp)(! \@g@wd \@g@ht)%
                              (! \@g@wd neg \@g@ht)(! \@g@wd neg \@g@dp)
            \multido{\i=0+1}{\psk@optexp@optgrid@count}{%
               \psline[liftpen=1](! \@g@wd neg \i\space \@g@step mul add \@g@dp)%
                                 (! \@g@wd neg \i\space \@g@step mul add 0)%
                                 (! \@g@wd neg \i\space 1 add \@g@step mul add \@g@dp)%
            }%
            \closepath
         }%
      \else%   
         \pscustom[linewidth=\psk@optexp@optgrid@linewidth]{%
            \psline[liftpen=1](! \@g@wd \@g@dp)(! \@g@wd \@g@ht)%
                              (! \@g@wd neg \@g@ht)(! \@g@wd neg \@g@dp)
            \multido{\i=0+1}{\psk@optexp@optgrid@count}{%
               \psline[liftpen=1](! \@g@wd neg \i\space \@g@step mul add \@g@dp)%
                                 (! \@g@wd neg \i\space 1 add \@g@step mul add 0)%
                                 (! \@g@wd neg \i\space 1 add \@g@step mul add \@g@dp)%
            }%
            \closepath
         }%
      \fi%
   \else\ifx\psk@optexp@optgrid@type\pst@string@optgrid@type@binary
      \pscustom[linewidth=\psk@optexp@optgrid@linewidth]{%
         \psline[liftpen=1](! \@g@wd \@g@dp)(! \@g@wd \@g@ht)%
                           (! \@g@wd neg \@g@ht)(! \@g@wd neg \@g@dp)
         \multido{\i=0+1}{\psk@optexp@optgrid@count}{%
            \psline[liftpen=1](! \@g@wd neg \i\space \@g@step mul add \@g@dp)%
                              (! \@g@wd neg \i\space \@g@step mul add 0)%
                              (! \@g@wd neg \i\space 0.5 add \@g@step mul add 0)%
                              (! \@g@wd neg \i\space 0.5 add \@g@step mul add \@g@dp)%
                              (! \@g@wd neg \i\space 1 add \@g@step mul add \@g@dp)%
         }%
      }%
   \fi\fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTBOX
%
\def\optbox@iii{%
   \edef\@b@wd{\psk@optexp@optbox@width\space 2 div\space}%
   \edef\@b@ht{\psk@optexp@optbox@height\space 2 div\space}%
   \ifPst@optexp@endbox
      \pnode(! \@b@wd 0){tempNode@Label}%
      \psframe(! 0 \@b@ht neg)(! \@b@wd 2 mul \@b@ht)%
   \else
      \rput{\psk@optexp@angle}(0,0){%
         \psframe(! \@b@wd neg \@b@ht neg)(! \@b@wd \@b@ht)%
      }%
   \fi
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTPLATE
%
\def\optplate@iii{%
   \psline[linewidth=\psk@optexp@plate@linewidth]%
          (! 0 \psk@optexp@plate@height\space 2 div neg)%
          (! 0 \psk@optexp@plate@height\space 2 div)
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% DETECTOR
%
\def\detector@iii{%
   \pnode(! \psk@optexp@detector@size\space 3 div 0){tempNode@Label}%
   \pswedge(0,0){\psk@optexp@detector@size}{-90}{90}
\ignorespaces}%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% OPTRETPLATE
%
\def\optretplate@iii{%
   \edef\@p@ht{\psk@optexp@plate@height\space 2 div\space}%
   \edef\@p@wd{\psk@optexp@plate@width\space 2 div\space}%
   \psframe(! \@p@wd neg \@p@ht neg)(! \@p@wd \@p@ht)
   \psline{cc-cc}(! \@p@wd neg \@p@ht)(! \@p@wd \@p@ht neg)
\ignorespaces}%
%
%
\endinput
%
