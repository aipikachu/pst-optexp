%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% THIS IS THE OLD CODE FOR ALL CONNECTIONS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% maintained for backward compatibility%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\newif\ifpoe@connjoin
\def\optexp@nodeA{\poe@key@b@sicname 1}%
\def\optexp@nodeB{\poe@key@b@sicname N}%
\def\POS@basicname@postfix{Intern}%
\define@key[psset]{optexp}{connjoin}{%
   \edef\pst@temp{#1}%
   \ifnum\pst@temp<0
       \poe@connjoinfalse
   \else\ifnum\pst@temp>2
       \poe@connjoinfalse
   \else
       \poe@connjointrue
       \edef\poe@key@connjoin{\pst@temp}
   \fi\fi
}%
\define@key[psset]{optexp}{conn}{%
   \edef\pst@tempg{#1}%
   \expandafter\psset@@conn\pst@tempg\@empty-\@empty\@nil
   \if@pst\else
      \pstrickserr{Bad connection specification: #1}\@ehpa
   \fi
}%
\def\psset@@conn#1-#2\@empty#3\@nil{%
  \@psttrue
  \def\next##1,#1-##2,##3\@nil{\def\pst@tempg{##2}}%
  \expandafter\next\pst@optexp@conntable,#1-#1,\@nil
  \@ifundefined{psoe@cs@in@\pst@tempg}%
    {\@pstfalse\def\poe@connIn{}}%
    {\edef\poe@connIn{psoe@cs@in@\pst@tempg}}%
  \@ifundefined{psoe@cs@out@#2}%
    {\@pstfalse\def\poe@connOut{}}%
    {\def\poe@connOut{psoe@cs@out@#2}}%
}%
\def\poe@connIn{}%
\def\poe@connOut{}%
% this is the conntable for the direct drawing of the connections
\def\pst@optexp@conntable{,o-o,i-i,f-f}%
%
\def\psoe@cs@out@{}%
\def\psoe@cs@in@{}%
\def\psoe@cs@in@o{\psline[style=Beam](\oenoderefa{})(\optexp@nodeA)}%
\def\psoe@cs@out@o{\psline[style=Beam](\optexp@nodeB)(\oenoderefb{})}%
\def\psoe@cs@in@f{%
   \pccurve[angleA=!\pst@optexpdict /N@\oenoderefb{}\space /N@\oenoderefa{}\space FiberAngleA end, 
            angleB=!\pst@optexpdict /N@\oenoderefb{}\space /N@\oenoderefa{}\space FiberAngleB end, 
            style=FiberIn](\oenoderefa{})(\optexp@nodeA)%
}%
\def\psoe@cs@out@f{%
   \pccurve[angleA=!\pst@optexpdict /N@\oenoderefb{}\space /N@\oenoderefa{}\space FiberAngleA end, 
            angleB=!\pst@optexpdict /N@\oenoderefb{}\space /N@\oenoderefa{}\space FiberAngleB end, 
            style=FiberOut](\optexp@nodeB)(\oenoderefb{})%
}%
\def\psoe@cs@in@i{%
   \def\pst@par{style=Beam}
   \begin@OpenObj
      \addto@pscode{%
         [
         \pst@optexpdict
            (\poe@key@b@sicname) false GetInternalBeamNodes 
            (N@\oenoderefa{}) @GetCenter 
         end
      }%
      \psline@ii
}%
\def\psoe@cs@out@i{%
   \def\pst@par{style=Beam}
   \begin@OpenObj
      \addto@pscode{%
         [
         \pst@optexpdict
            (N@\oenoderefb{}) @GetCenter
            (\poe@key@b@sicname) false GetInternalBeamNodes 
         end
      }%
      \psline@ii
}%
%
% IN
\def\psoe@cs@in@a{(N@\optexp@nodeA) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@in@A{\pst@optexpdict (\poe@key@b@sicname) true GetInternalBeamNodes end }%
\def\psoe@cs@in@b{(N@\optexp@nodeB) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@in@B{\pst@optexpdict (\poe@key@b@sicname) false GetInternalBeamNodes end }%
%
% OUT
%
\def\psoe@cs@out@a{(N@\optexp@nodeA) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@out@A{\pst@optexpdict (\poe@key@b@sicname) false GetInternalBeamNodes end }%
\def\psoe@cs@out@b{(N@\optexp@nodeB) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@out@B{\pst@optexpdict (\poe@key@b@sicname) true GetInternalBeamNodes end }%
\def\drawbeam{%
   \def\conntable{,a-a,b-b,A-A,B-B}%
   \begingroup
   \psset{style=Beam}%
   \pst@object{drawbeam}%
}%
% 
\def\pst@optexp@getfirstchar#1#2\@nil{#1}%
\def\drawbeam@i#1#2{%
   \def\pst@tempA{\pst@optexp@getfirstchar#1\@nil}%
   \def\pst@tempB{\pst@optexp@getfirstchar#2\@nil}%
   \ifpoe@connjoin
      \psset{linejoin=\poe@key@connjoin}%
   \fi
   \begin@OpenObj%
   \if(\pst@tempB
      % second parameter is a node
      \pst@optexp@@getcoor#2
      \def\poe@connOut{pst@coor}%
   \else
      \pst@optexp@check@compname{#2}%
      \edef\poe@key@b@sicnameB{#2\POS@basicname@postfix}%
   \fi
   \if(\pst@tempA
   %   % first parameter is a node
      \pst@optexp@@getcoor#1%
      \def\poe@connIn{pst@coor}%
   \else
      \pst@optexp@check@compname{#1}%
      \edef\poe@key@b@sicnameA{#1\POS@basicname@postfix}%
   \fi
   \let\poe@key@b@sicname\poe@key@b@sicnameB
   \addto@pscode{[ \@nameuse{\poe@connOut}}%
   \let\poe@key@b@sicname\poe@key@b@sicnameA
   \addto@pscode{\@nameuse{\poe@connIn}}%
   \psline@ii
   \endgroup
\ignorespaces}%
%
\def\pst@optexp@@getcoor(#1){%
  \pst@@getcoor{#1}%
\ignorespaces}%
%
\def\draw@InternalConnections{%
   \ifpoe@endbox
      \@nameuse{\poe@connIn}
   \else
      \ifpoe@fiber@
        \ifpoe@fiberin@
          \@nameuse{\poe@connIn}
        \fi
        \ifpoe@fiberout@
          \@nameuse{\poe@connOut}
        \fi
      \else
         \ifpoe@connjoin
            \def\tmp@A{psoe@cs@in@i}%
            \ifx\tmp@A\poe@connIn
               \def\tmp@B{psoe@cs@out@o}
               \ifx\tmp@B\poe@connOut
                  \pscustom[style=Beam, linejoin=\poe@key@connjoin]{\@nameuse{\poe@connIn}\@nameuse{\poe@connOut}}%
               \else\ifx\@empty\poe@connOut
                  \pscustom[style=Beam, linejoin=\poe@key@connjoin]{\@nameuse{\poe@connIn}\@nameuse{\poe@connOut}}%
               \else
                  \@nameuse{\poe@connIn}\@nameuse{\poe@connOut}%
               \fi\fi
            \else
               \def\tmp@A{psoe@cs@in@o}%
               \ifx\tmp@A\poe@connIn
                  \def\tmp@B{psoe@cs@out@o}
                  \ifx\tmp@B\poe@connOut
                     \@nameuse{\poe@connIn}\@nameuse{\poe@connOut}%
                  \else\ifx\@empty\poe@connOut
                     \pscustom[style=Beam, linejoin=\poe@key@connjoin]{\@nameuse{\poe@connIn}\@nameuse{\poe@connOut}}%
                  \else
                     \pscustom[style=Beam, linejoin=\poe@key@connjoin]{\@nameuse{\poe@connIn}\@nameuse{\poe@connOut}}%
                  \fi\fi
               \else
                  \@nameuse{\poe@connIn}\@nameuse{\poe@connOut}%
               \fi
            \fi
         \else
            \@nameuse{\poe@connIn}\@nameuse{\poe@connOut}%
         \fi
      \fi
   \fi
}%
\define@choicekey[psset]{optexp}{beam}[\val\nr]{}[]{%
   \psset{conn=o-i}%
}
\define@choicekey[psset]{optexp}{fiber}[\val\nr]{}[]{%
   \psset{conn=f-f, fiberin, fiberout}%
}
\define@choicekey[psset]{optexp}{nofiber}[\val\nr]{}[]{%
   \psset{conn=-, fiberin=none, fiberout=none}%
}
\poe@compattrue
\psset[optexp]{%
  conn=-
  , connjoin=1
  , namingscheme=old
}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% End of compatibility code %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\endinput
