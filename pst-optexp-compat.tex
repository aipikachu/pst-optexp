%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% THIS IS THE OLD CODE FOR ALL CONNECTIONS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% maintained for backward compatibility%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\define@key[psset]{optexp}{connjoin}{%
   \edef\pst@temp{#1}%
   \ifnum\pst@temp<0
       \POE@connjoinfalse
   \else\ifnum\pst@temp>2
       \POE@connjoinfalse
   \else
       \POE@connjointrue
       \edef\POK@connjoin{\pst@temp}
   \fi\fi
}%
\define@key[psset]{optexp}{conn}{%
   \edef\pst@tempg{#1}%
   \expandafter\psset@@conn\pst@tempg\@empty-\@empty\@nil
   \if@pst\else
      \pstrickserr{Bad connection specification: #1}\@ehpa
   \fi
}%
\def\psset@@conn#1-#2\@empty#3\@nil{%
  \@psttrue
  \def\next##1,#1-##2,##3\@nil{\def\pst@tempg{##2}}%
  \expandafter\next\pst@optexp@conntable,#1-#1,\@nil
  \@ifundefined{psoe@cs@in@\pst@tempg}%
    {\@pstfalse\def\psk@connIn{}}%
    {\edef\psk@connIn{psoe@cs@in@\pst@tempg}}%
  \@ifundefined{psoe@cs@out@#2}%
    {\@pstfalse\def\psk@connOut{}}%
    {\def\psk@connOut{psoe@cs@out@#2}}%
}%
\def\psk@connIn{}%
\def\psk@connOut{}%
% this is the conntable for the direct drawing of the connections
\def\pst@optexp@conntable{,o-o,i-i,f-f}%
%
\def\psoe@cs@out@{}%
\def\psoe@cs@in@{}%
\def\psoe@cs@in@o{\psline[style=Beam](\optexp@nodeA)(\optexp@nodeIn)}%
\def\psoe@cs@out@o{\psline[style=Beam](\optexp@nodeOut)(\optexp@nodeB)}%
\def\psoe@cs@in@f{%
   \pccurve[angleA=!\pst@optexpdict /N@\optexp@nodeB\space /N@\optexp@nodeA\space FiberAngleA end, 
            angleB=!\pst@optexpdict /N@\optexp@nodeB\space /N@\optexp@nodeA\space FiberAngleB end, 
            style=FiberIn](\optexp@nodeA)(\optexp@nodeIn)%
}%
\def\psoe@cs@out@f{%
   \pccurve[angleA=!\pst@optexpdict /N@\optexp@nodeB\space /N@\optexp@nodeA\space FiberAngleA end, 
            angleB=!\pst@optexpdict /N@\optexp@nodeB\space /N@\optexp@nodeA\space FiberAngleB end, 
            style=FiberOut](\optexp@nodeOut)(\optexp@nodeB)%
}%
\def\psoe@cs@in@i{%
   \def\pst@par{style=Beam}
   \begin@OpenObj
      \addto@pscode{%
         [
         \pst@optexpdict
            (\POK@b@sicname) false GetInternalBeamNodes 
            (N@\optexp@nodeA) @GetCenter 
         end
      }%
      \psline@ii
}%
\def\psoe@cs@out@i{%
   \def\pst@par{style=Beam}
   \begin@OpenObj
      \addto@pscode{%
         [
         \pst@optexpdict
            (N@\optexp@nodeB) @GetCenter
            (\POK@b@sicname) false GetInternalBeamNodes 
         end
      }%
      \psline@ii
}%
%
% IN
\def\psoe@cs@in@a{(N@\optexp@nodeIn) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@in@A{\pst@optexpdict (\POK@b@sicname) true GetInternalBeamNodes end }%
\def\psoe@cs@in@b{(N@\optexp@nodeOut) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@in@B{\pst@optexpdict (\POK@b@sicname) false GetInternalBeamNodes end }%
%
% OUT
%
\def\psoe@cs@out@a{(N@\optexp@nodeIn) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@out@A{\pst@optexpdict (\POK@b@sicname) false GetInternalBeamNodes end }%
\def\psoe@cs@out@b{(N@\optexp@nodeOut) \pst@optexpdict @GetCenter end }%
\def\psoe@cs@out@B{\pst@optexpdict (\POK@b@sicname) true GetInternalBeamNodes end }%
\def\drawbeam{%
   \def\conntable{,a-a,b-b,A-A,B-B}%
   \begingroup
   \psset{style=Beam}%
   \pst@object{drawbeam}%
}%
\def\drawbeam@i#1#2{%
   \def\pst@tempA{\pst@optexp@getfirstchar#1\@nil}%
   \def\pst@tempB{\pst@optexp@getfirstchar#2\@nil}%
   \ifPOE@connjoin
      \psset{linejoin=\POK@connjoin}%
   \fi
   \begin@OpenObj%
   \if(\pst@tempB
      % second parameter is a node
      \pst@optexp@@getcoor#2
      \def\psk@connOut{pst@coor}%
   \else
%      \pst@optexp@check@compname{#2}%
      \edef\POK@b@sicnameB{#2}%
   \fi
   \if(\pst@tempA
   %   % first parameter is a node
      \pst@optexp@@getcoor#1%
      \def\psk@connIn{pst@coor}%
   \else
%      \pst@optexp@check@compname{#1}%
      \edef\POK@b@sicnameA{#1}%
   \fi
   \let\POK@b@sicname\POK@b@sicnameB
   \addto@pscode{[ \@nameuse{\psk@connOut}}%
   \let\POK@b@sicname\POK@b@sicnameA
   \addto@pscode{\@nameuse{\psk@connIn}}%
   \psline@ii
   \endgroup
\ignorespaces}%
%
\def\pst@optexp@@getcoor(#1){%
  \pst@@getcoor{#1}%
\ignorespaces}%
%
\def\draw@InternalConnections{%
   \ifPOE@endbox
      \@nameuse{\psk@connIn}
   \else
      \ifPOE@fiber@
        \ifPOE@fiberin@
          \@nameuse{\psk@connIn}
        \fi
        \ifPOE@fiberout@
          \@nameuse{\psk@connOut}
        \fi
      \else
         \ifPOE@connjoin
            \def\tmp@A{psoe@cs@in@i}%
            \ifx\tmp@A\psk@connIn
               \def\tmp@B{psoe@cs@out@o}
               \ifx\tmp@B\psk@connOut
                  \pscustom[style=Beam, linejoin=\POK@connjoin]{\@nameuse{\psk@connIn}\@nameuse{\psk@connOut}}%
               \else\ifx\@empty\psk@connOut
                  \pscustom[style=Beam, linejoin=\POK@connjoin]{\@nameuse{\psk@connIn}\@nameuse{\psk@connOut}}%
               \else
                  \@nameuse{\psk@connIn}\@nameuse{\psk@connOut}%
               \fi\fi
           \else
               \def\tmp@A{psoe@cs@in@o}%
               \ifx\tmp@A\psk@connIn
                  \def\tmp@B{psoe@cs@out@o}
                  \ifx\tmp@B\psk@connOut
                     \pscustom[style=Beam, linejoin=\POK@connjoin]{\@nameuse{\psk@connIn}\@nameuse{\psk@connOut}}%
                  \else\ifx\@empty\psk@connOut
                     \pscustom[style=Beam, linejoin=\POK@connjoin]{\@nameuse{\psk@connIn}\@nameuse{\psk@connOut}}%
                  \else
                     \@nameuse{\psk@connIn}\@nameuse{\psk@connOut}%
                  \fi\fi
               \else
                  \@nameuse{\psk@connIn}\@nameuse{\psk@connOut}%
               \fi
            \fi
         \else
            \@nameuse{\psk@connIn}\@nameuse{\psk@connOut}%
         \fi
      \fi
   \fi
}%
\define@choicekey[psset]{optexp}{beam}[\val\nr]{}[]{%
   \psset{conn=i-o}%
}
\define@choicekey[psset]{optexp}{fiber}[\val\nr]{}[]{%
   \psset{conn=f-f, fiberin, fiberout}%
}
\define@choicekey[psset]{optexp}{nofiber}[\val\nr]{}[]{%
   \psset{conn=-, fiberin=none, fiberout=none}%
}
\POE@compattrue
\psset[optexp]{%
  conn=-
  , connjoin=1
  , namingscheme=old
}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% End of compatibility code %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\endinput
